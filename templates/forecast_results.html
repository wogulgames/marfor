<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarFor - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≥–Ω–æ–∑–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .forecast-badge {
            background-color: #ffc107;
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .forecast-row {
            background-color: #fff3cd !important;
        }
        
        /* –ú—è—Ç–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
        .btn-primary {
            background-color: #81db99 !important;
            border-color: #81db99 !important;
            color: #000 !important;
        }
        
        .btn-primary:hover {
            background-color: #6bc884 !important;
            border-color: #6bc884 !important;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã */
        .pivot-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .pivot-table th, .pivot-table td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: left;
        }
        
        .pivot-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .pivot-row-level-0 {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .pivot-row-level-1 {
            padding-left: 20px;
        }
        
        .pivot-row-level-2 {
            padding-left: 40px;
        }
        
        .pivot-total-row {
            background-color: #e9ecef;
            font-weight: 700;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
        .filter-card {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            margin-bottom: 0.75rem;
            background-color: #f8f9fa;
        }
        
        .filter-header {
            background-color: #e9ecef;
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
            color: #495057;
            font-size: 0.875rem;
        }
        
        .filter-body {
            padding: 0.75rem;
        }
        
        .filter-option {
            display: flex;
            align-items: center;
            padding: 0.25rem 0;
        }
        
        .filter-option input[type="checkbox"] {
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>MarFor
            </a>
            <span class="navbar-text text-white">
                –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≥–Ω–æ–∑–∞
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–≥–Ω–æ–∑–µ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-info-circle me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–≥–Ω–æ–∑–µ</h5>
            </div>
            <div class="card-body" id="forecastInfo">
                <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>

        <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0" id="pivotModeTitle">
                    <i class="fas fa-clock me-2"></i>–†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã
                </h6>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-secondary active" id="timeSeriesModeBtn" onclick="switchPivotMode('time-series')">
                        <i class="fas fa-clock me-1"></i>–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="slicesModeBtn" onclick="switchPivotMode('slices')">
                        <i class="fas fa-layer-group me-1"></i>–°—Ä–µ–∑—ã
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label" id="primaryFieldLabel">–ú–µ—Ç—Ä–∏–∫–∏</label>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="primaryFieldDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <span id="primaryFieldDropdownText">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç—Ä–∏–∫–∏</span>
                            </button>
                            <ul class="dropdown-menu w-100" id="primaryFieldDropdownMenu">
                                <li class="dropdown-item-text">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAllPrimary" onchange="toggleAllPrimaryFields(this)">
                                        <label class="form-check-label fw-bold" for="selectAllPrimary">
                                            –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                                        </label>
                                    </div>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <div id="primaryFieldCheckboxes">
                                    <!-- –ß–µ–∫–±–æ–∫—Å—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </div>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" id="splitFieldLabel">–†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Å—Ä–µ–∑–∞–º</label>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="splitFieldDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <span id="splitFieldDropdownText">–¢–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã</span>
                            </button>
                            <ul class="dropdown-menu w-100" id="splitFieldDropdownMenu">
                                <li class="dropdown-item-text">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="splitFieldSelection" id="noSplitFieldSelection" value="" onchange="updateSelectedSplitField()" checked>
                                        <label class="form-check-label fw-bold" for="noSplitFieldSelection">
                                            <span id="noSplitFieldText">–¢–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã</span>
                                        </label>
                                    </div>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <div id="splitFieldRadioButtons">
                                    <!-- –†–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </div>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- –°–µ–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-filter me-2"></i>–§–∏–ª—å—Ç—Ä—ã
                                </h6>
                                <button class="btn btn-sm btn-outline-secondary" onclick="resetAllFilters()">
                                    <i class="fas fa-undo me-1"></i>–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="filtersContainer">
                                    <!-- –§–∏–ª—å—Ç—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                    <p class="text-muted text-center">–§–∏–ª—å—Ç—Ä—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center">
                    <button class="btn btn-primary" id="buildChartBtn" onclick="loadTimeSeriesData();">
                        <i class="fas fa-chart-line me-2"></i>–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫
                    </button>
                </div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –∏ —Ç–∞–±–ª–∏—Ü—ã -->
        <div id="timeSeriesChartContainer">
            <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω–∞ —Å–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∏ –≥—Ä–∞—Ñ–∏–∫ -->
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="card mb-4">
            <div class="card-body text-center">
                <button class="btn btn-success me-2" onclick="exportResults()">
                    <i class="fas fa-download me-2"></i>–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                </button>
                <button class="btn btn-secondary me-2" onclick="window.location.href='/forecast/training?session_id=' + currentSessionId">
                    <i class="fas fa-arrow-left me-2"></i>–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±—É—á–µ–Ω–∏—é
                </button>
                <button class="btn btn-primary" onclick="window.location.href='/forecast/settings?session_id=' + currentSessionId">
                    <i class="fas fa-cog me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/pivot_table_system.js"></script>
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentSessionId = null;
        let forecastData = null;
        let currentPivotData = null;
        let rawPivotData = null;
        let currentPivotConfig = null;
        let currentFilters = [];
        let processedData = null;
        let dataMapping = null;
        let dataColumns = [];
        let dataInfo = null;
        let selectedSliceForSplit = '';
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
        const pivotState = {
            currentPivotMode: 'time-series',
            selectedMetrics: [],
            selectedSlices: [],
            selectedSplitField: ''
        };

        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            currentSessionId = urlParams.get('session_id') || sessionStorage.getItem('currentSessionId');
            
            if (!currentSessionId) {
                alert('–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                window.location.href = '/forecast';
                return;
            }
            
            await loadForecastResults();
        });

        async function loadForecastResults() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≥–Ω–æ–∑–∞
                const response = await fetch(`/api/get_forecast_results/${currentSessionId}`);
                const result = await response.json();
                
                if (result.success) {
                    forecastData = result.forecast_data;
                    displayForecastInfo(result.info);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                    rawPivotData = forecastData.raw_data;
                    currentPivotData = forecastData.raw_data;
                    
                    // –ü–æ–ª—É—á–∞–µ–º –º–∞–ø–ø–∏–Ω–≥ –∏–∑ sessionStorage
                    const mappingStr = sessionStorage.getItem('dataMapping');
                    dataMapping = mappingStr ? JSON.parse(mappingStr) : null;
                    
                    if (dataMapping) {
                        console.log('üìä –ó–∞–≥—Ä—É–∂–µ–Ω –º–∞–ø–ø–∏–Ω–≥:', dataMapping);
                        
                        // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–æ–Ω–∫–∞—Ö
                        dataColumns = dataMapping.columns ? dataMapping.columns.map(c => c.name) : [];
                        
                        // –°–æ–∑–¥–∞–µ–º dataInfo –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                        dataInfo = {
                            columns: dataColumns,
                            sample_data: rawPivotData.slice(0, 10)
                        };
                        
                        // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                        populateTimeSeriesSelects();
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                        setTimeout(() => {
                            loadTimeSeriesData();
                        }, 500);
                    } else {
                        console.warn('‚ö†Ô∏è –ú–∞–ø–ø–∏–Ω–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ sessionStorage');
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ' + result.message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ' + error.message);
            }
        }

        function displayForecastInfo(info) {
            const infoDiv = document.getElementById('forecastInfo');
            
            infoDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <p><strong>–ú–æ–¥–µ–ª—å:</strong> ${getModelDisplayName(info.model)}</p>
                    </div>
                    <div class="col-md-3">
                        <p><strong>–ú–µ—Ç—Ä–∏–∫–∞:</strong> ${info.metric}</p>
                    </div>
                    <div class="col-md-3">
                        <p><strong>–§–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–∏–æ–¥–æ–≤:</strong> ${info.historical_periods}</p>
                    </div>
                    <div class="col-md-3">
                        <p><strong>–ü—Ä–æ–≥–Ω–æ–∑–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤:</strong> 
                            <span class="forecast-badge">${info.forecast_periods}</span>
                        </p>
                    </div>
                </div>
                <div class="alert alert-warning mt-2">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>–ü—Ä–æ–≥–Ω–æ–∑–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã –æ—Ç–º–µ—á–µ–Ω—ã –∂–µ–ª—Ç—ã–º —Ü–≤–µ—Ç–æ–º</strong> –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ –∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
                </div>
            `;
        }

        function getModelDisplayName(modelName) {
            const names = {
                'arima': 'ARIMA',
                'prophet': 'Prophet',
                'random_forest': 'Random Forest'
            };
            return names[modelName] || modelName;
        }

        function exportResults() {
            if (!currentSessionId) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }
            
            // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
            window.open(`/api/export_forecast/${currentSessionId}`, '_blank');
        }
        
        // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è createAutoFilters (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ pivot_table_system.js)
        function createAutoFilters() {
            console.log('‚úÖ createAutoFilters –≤—ã–∑–≤–∞–Ω–∞');
            
            if (!rawPivotData || !dataMapping) {
                console.log('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤');
                return [];
            }
            
            const filtersContainer = document.getElementById('filtersContainer');
            if (!filtersContainer) {
                console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return [];
            }
            
            filtersContainer.innerHTML = '';
            currentFilters = [];
            
            // –°–æ–∑–¥–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è dimension-–∫–æ–ª–æ–Ω–æ–∫
            const dimensionColumns = dataMapping.columns.filter(col => 
                col.role === 'dimension' && col.include
            );
            
            console.log('üìä –°–æ–∑–¥–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è', dimensionColumns.length, '–∫–æ–ª–æ–Ω–æ–∫');
            
            dimensionColumns.forEach(col => {
                const filter = createFilter(col.name, col.type);
                if (filter) {
                    currentFilters.push(filter);
                }
            });
            
            return currentFilters;
        }
        
        function createFilter(columnName, columnType) {
            // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            const uniqueValues = [...new Set(rawPivotData.map(row => row[columnName]))].filter(v => v !== null && v !== undefined && v !== '');
            
            if (uniqueValues.length === 0) {
                return null;
            }
            
            const filterDiv = document.createElement('div');
            filterDiv.className = 'filter-card';
            filterDiv.innerHTML = `
                <div class="filter-header">${columnName}</div>
                <div class="filter-body" id="filter-${columnName}">
                    ${uniqueValues.slice(0, 20).map(value => `
                        <div class="filter-option">
                            <input type="checkbox" id="filter-${columnName}-${value}" value="${value}" checked onchange="applyFilters()">
                            <label for="filter-${columnName}-${value}">${value}</label>
                        </div>
                    `).join('')}
                    ${uniqueValues.length > 20 ? `<p class="text-muted small">... –∏ –µ—â–µ ${uniqueValues.length - 20}</p>` : ''}
                </div>
            `;
            
            document.getElementById('filtersContainer').appendChild(filterDiv);
            
            return {
                field: columnName,
                type: columnType,
                values: uniqueValues
            };
        }
        
        function applyFilters() {
            console.log('üîç –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤...');
            loadTimeSeriesData();
        }
        
        function resetAllFilters() {
            const checkboxes = document.querySelectorAll('#filtersContainer input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            applyFilters();
        }
        
        function getFilteredData() {
            if (!rawPivotData) return [];
            
            let filtered = [...rawPivotData];
            
            currentFilters.forEach(filter => {
                const selectedValues = [];
                const checkboxes = document.querySelectorAll(`#filter-${filter.field} input[type="checkbox"]:checked`);
                checkboxes.forEach(cb => selectedValues.push(cb.value));
                
                if (selectedValues.length > 0 && selectedValues.length < filter.values.length) {
                    filtered = filtered.filter(row => selectedValues.includes(String(row[filter.field])));
                }
            });
            
            return filtered;
        }

        // –ö–æ–ø–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ marfor_interface.html
        function populateTimeSeriesSelects() {
            console.log('üöÄ populateTimeSeriesSelects() –≤—ã–∑–≤–∞–Ω–∞, —Ä–µ–∂–∏–º:', pivotState.currentPivotMode);
            
            const primaryFieldCheckboxes = document.getElementById('primaryFieldCheckboxes');
            const primaryFieldDropdownText = document.getElementById('primaryFieldDropdownText');
            const splitFieldRadioButtons = document.getElementById('splitFieldRadioButtons');
            const splitFieldDropdownText = document.getElementById('splitFieldDropdownText');
            
            if (!primaryFieldCheckboxes) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç —á–µ–∫–±–æ–∫—Å–æ–≤ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            primaryFieldCheckboxes.innerHTML = '';
            splitFieldRadioButtons.innerHTML = '';
            
            let availablePrimaryFields = [];
            let availableSplitFields = [];
            
            if (pivotState.currentPivotMode === 'time-series') {
                // –†–µ–∂–∏–º –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤: –º–µ—Ç—Ä–∏–∫–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–æ–ª–µ, —Å—Ä–µ–∑—ã –¥–ª—è —Ä–∞–∑–±–∏–≤–∫–∏
                availablePrimaryFields = dataMapping.columns.filter(col => col.role === 'metric' && col.include);
                availableSplitFields = dataMapping.columns.filter(col => col.role === 'dimension' && !col.time_series && col.include);
                
                document.getElementById('primaryFieldLabel').textContent = '–ú–µ—Ç—Ä–∏–∫–∏';
                document.getElementById('splitFieldLabel').textContent = '–†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Å—Ç–æ–ª–±—Ü–∞–º';
                document.getElementById('noSplitFieldText').textContent = '–¢–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã';
            } else {
                // –†–µ–∂–∏–º —Å—Ä–µ–∑–æ–≤: —Å—Ä–µ–∑—ã –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–æ–ª–µ, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã –¥–ª—è —Ä–∞–∑–±–∏–≤–∫–∏
                availablePrimaryFields = dataMapping.columns.filter(col => col.role === 'dimension' && !col.time_series && col.include);
                availableSplitFields = dataMapping.columns.filter(col => col.time_series && col.include);
                
                document.getElementById('primaryFieldLabel').textContent = '–°—Ä–µ–∑—ã';
                document.getElementById('splitFieldLabel').textContent = '–†–∞–∑–±–∏–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏';
                document.getElementById('noSplitFieldText').textContent = '–¢–æ–ª—å–∫–æ —Å—Ä–µ–∑—ã';
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —á–µ–∫–±–æ–∫—Å—ã –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—è
            availablePrimaryFields.forEach(field => {
                const li = document.createElement('li');
                li.className = 'dropdown-item-text';
                li.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="primary-${field.name}" value="${field.name}" onchange="updateSelectedMetrics()">
                        <label class="form-check-label" for="primary-${field.name}">
                            ${field.name}
                        </label>
                    </div>
                `;
                primaryFieldCheckboxes.appendChild(li);
            });
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏ —Ä–∞–∑–±–∏–≤–∫–∏
            availableSplitFields.forEach(field => {
                const li = document.createElement('li');
                li.className = 'dropdown-item-text';
                li.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="splitFieldSelection" id="split-${field.name}" value="${field.name}" onchange="updateSelectedSplitField()">
                        <label class="form-check-label" for="split-${field.name}">
                            ${field.name}
                        </label>
                    </div>
                `;
                splitFieldRadioButtons.appendChild(li);
            });
            
            // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –º–µ—Ç—Ä–∏–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (availablePrimaryFields.length > 0) {
                const firstCheckbox = document.getElementById(`primary-${availablePrimaryFields[0].name}`);
                if (firstCheckbox) {
                    firstCheckbox.checked = true;
                    updateSelectedMetrics();
                }
            }
        }
        
        function updateSelectedMetrics() {
            const checkboxes = document.querySelectorAll('#primaryFieldCheckboxes input[type="checkbox"]');
            const selectedMetrics = [];
            const primaryFieldDropdownText = document.getElementById('primaryFieldDropdownText');
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedMetrics.push(checkbox.value);
                }
            });
            
            if (selectedMetrics.length === 0) {
                primaryFieldDropdownText.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç—Ä–∏–∫–∏';
            } else if (selectedMetrics.length === 1) {
                primaryFieldDropdownText.textContent = selectedMetrics[0];
            } else {
                primaryFieldDropdownText.textContent = '–í—ã–±—Ä–∞–Ω–æ: ' + selectedMetrics.length;
            }
            
            window.selectedMetrics = selectedMetrics;
            pivotState.selectedMetrics = selectedMetrics;
        }
        
        function updateSelectedSplitField() {
            const selectedRadio = document.querySelector('input[name="splitFieldSelection"]:checked');
            const selectedField = selectedRadio ? selectedRadio.value : '';
            const splitFieldDropdownText = document.getElementById('splitFieldDropdownText');
            
            if (selectedField) {
                splitFieldDropdownText.textContent = `–†–∞–∑–±–∏–≤–∫–∞: ${selectedField}`;
            } else {
                if (pivotState.currentPivotMode === 'time-series') {
                    splitFieldDropdownText.textContent = '–¢–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã';
                } else {
                    splitFieldDropdownText.textContent = '–¢–æ–ª—å–∫–æ —Å—Ä–µ–∑—ã';
                }
            }
            
            selectedSliceForSplit = selectedField;
            pivotState.selectedSplitField = selectedField;
        }
        
        function toggleAllPrimaryFields(checkbox) {
            const checkboxes = document.querySelectorAll('#primaryFieldCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateSelectedMetrics();
        }
        
        function switchPivotMode(mode) {
            console.log('üîÑ switchPivotMode –≤—ã–∑–≤–∞–Ω–∞ —Å —Ä–µ–∂–∏–º–æ–º:', mode);
            pivotState.currentPivotMode = mode;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            document.getElementById('timeSeriesModeBtn').classList.toggle('active', mode === 'time-series');
            document.getElementById('slicesModeBtn').classList.toggle('active', mode === 'slices');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const titleElement = document.getElementById('pivotModeTitle');
            if (mode === 'time-series') {
                titleElement.innerHTML = '<i class="fas fa-clock me-2"></i>–†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã';
            } else {
                titleElement.innerHTML = '<i class="fas fa-layer-group me-2"></i>–†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: –°—Ä–µ–∑—ã';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç—ã
            populateTimeSeriesSelects();
        }
        
        function loadTimeSeriesData() {
            console.log('üî• === –§–£–ù–ö–¶–ò–Ø loadTimeSeriesData() –í–´–ó–í–ê–ù–ê ===');
            
            if (!currentSessionId) {
                console.error('–°–µ—Å—Å–∏—è –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                alert('–û—à–∏–±–∫–∞: —Å–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            if (!rawPivotData || !dataMapping) {
                console.error('–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                alert('–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
            const selectedMetrics = pivotState.selectedMetrics.length > 0 ? 
                pivotState.selectedMetrics : 
                [dataMapping.columns.find(c => c.role === 'metric')?.name].filter(Boolean);
            
            if (selectedMetrics.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –º–µ—Ç—Ä–∏–∫—É');
                return;
            }
            
            console.log('üìä –í—ã–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:', selectedMetrics);
            console.log('üìä –†–µ–∂–∏–º:', pivotState.currentPivotMode);
            console.log('üìä –†–∞–∑–±–∏–≤–∫–∞:', selectedSliceForSplit);
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
            const filteredData = getFilteredData();
            console.log('üìä –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ —Å—Ç—Ä–æ–∫:', filteredData.length);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–∑–±–∏–≤–∫–∏
            const splitMode = selectedSliceForSplit ? 'split-columns' : pivotState.currentPivotMode;
            
            // –†–µ–Ω–¥–µ—Ä–∏–º —Å–≤–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
            if (typeof renderNewPivotTable === 'function') {
                renderNewPivotTable(
                    filteredData,
                    dataMapping,
                    pivotState.currentPivotMode,
                    selectedSliceForSplit
                );
            } else {
                console.error('‚ùå –§—É–Ω–∫—Ü–∏—è renderNewPivotTable –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
            }
        }
    </script>
</body>
</html>
