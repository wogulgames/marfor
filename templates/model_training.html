<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARFOR - Обучение модели</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/breadcrumbs.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .btn-primary {
            background-color: #81db99 !important;
            border-color: #81db99 !important;
            color: #000 !important;
        }
        
        .btn-primary:hover {
            background-color: #6bc884 !important;
        }
        
        .model-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .model-card:hover {
            border-color: #81db99;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .model-card.selected {
            border-color: #81db99;
            background: #f1f8f4;
        }
        
        .metric-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            margin: 3px;
            font-size: 0.9em;
        }
        
        .metric-good {
            background: #4caf50;
            color: white;
        }
        
        .metric-medium {
            background: #ff9800;
            color: white;
        }
        
        .metric-bad {
            background: #f44336;
            color: white;
        }
        
        .training-status {
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .training-status.running {
            background: #e3f2fd;
            border: 2px solid #2196f3;
        }
        
        .training-status.complete {
            background: #e8f5e9;
            border: 2px solid #4caf50;
        }
    </style>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/forecast">
                <img src="/static/images/logo.png" alt="MARFOR Logo" height="32" class="me-2" style="object-fit: contain;">
                <strong>MARFOR</strong>
            </a>
            <span class="navbar-text">
                <i class="fas fa-brain me-2"></i>Обучение и валидация модели
            </span>
            <div class="ms-auto">
                <span class="badge bg-success" style="font-size: 0.8em;">
                    <i class="fas fa-code"></i> v2.19.2
                </span>
            </div>
        </div>
    </nav>

    <!-- Хлебные крошки -->
    <div id="breadcrumbContainer"></div>

    <!-- Основной контент -->
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <!-- Информация о настройках -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>Настройки прогнозирования
                        </h6>
                    </div>
                    <div class="card-body" id="forecastSettingsInfo">
                        Загрузка...
                    </div>
                </div>

                <!-- Разделение данных -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-database me-2"></i>Разделение данных на обучающую и контрольную выборки
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Размер контрольной выборки (%):</label>
                                <input type="range" class="form-range" id="testSizeSlider" min="10" max="40" value="20" oninput="updateTestSizeLabel()">
                                <div class="text-center">
                                    <span id="testSizeLabel" class="badge bg-info">20%</span>
                                    <small class="text-muted d-block mt-2">Обучающая: 80% | Контрольная: 20%</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Обучающая выборка</strong> - для обучения моделей<br>
                                    <strong>Контрольная выборка</strong> - для проверки точности
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Выбор моделей -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-sliders-h me-2"></i>Выбор моделей для обучения
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Две модели Random Forest:</strong> Базовая (быстрая) и продвинутая с иерархическим согласованием, 
                            лагами, rolling-признаками и сезонными синусоидами. Выберите модели для сравнения!
                        </div>
                        
                        <div class="row">
                            <!-- Random Forest (базовая) -->
                            <div class="col-md-6">
                                <div class="model-card" onclick="toggleModel('random_forest')">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="model_random_forest" checked>
                                        <label class="form-check-label fw-bold" for="model_random_forest">
                                            <i class="fas fa-tree me-2"></i>Random Forest
                                        </label>
                                    </div>
                                    <small class="text-muted">
                                        Базовая модель. Признаки: year, month, срезы (закодированные). Быстрая и простая.
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Random Forest Hierarchy (продвинутая) -->
                            <div class="col-md-6">
                                <div class="model-card" onclick="toggleModel('random_forest_hierarchy')">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="model_random_forest_hierarchy" checked>
                                        <label class="form-check-label fw-bold" for="model_random_forest_hierarchy">
                                            <i class="fas fa-project-diagram me-2"></i>Random Forest Hierarchy
                                        </label>
                                    </div>
                                    <small class="text-muted">
                                        Продвинутая модель. Лаги (1,2,3,4,6,12), rolling (mean/std/min/max), сезонные синусоиды, иерархическое согласование.
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <button class="btn btn-success btn-lg" onclick="trainModels()">
                                <i class="fas fa-play me-2"></i>Запустить обучение моделей
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Статус обучения -->
                <div id="trainingStatus" style="display: none;">
                    <div class="training-status running">
                        <div class="spinner-border text-primary me-3" role="status">
                            <span class="visually-hidden">Обучение...</span>
                        </div>
                        <span class="fs-5">Обучение моделей...</span>
                        <div id="trainingProgress" class="mt-2"></div>
                    </div>
                </div>

                <!-- Результаты обучения -->
                <div id="trainingResults" style="display: none;">
                    <div class="card mb-3">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-check-circle me-2"></i>Результаты обучения
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Таблица сравнения моделей -->
                            <h6 class="mb-3">Сравнение моделей:</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Модель</th>
                                            <th>MAE<br><small>(средняя абсолютная ошибка)</small></th>
                                            <th>RMSE<br><small>(корень из средней квадратичной)</small></th>
                                            <th>MAPE, %<br><small>(средняя процентная ошибка)</small></th>
                                            <th>Рейтинг</th>
                                        </tr>
                                    </thead>
                                    <tbody id="modelsComparisonTable">
                                        <!-- Заполняется динамически -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- График: Факт vs Прогноз -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-dark">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-area me-2"></i>Валидация на контрольной выборке
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Выберите модель прогнозирования:</label>
                                <select id="modelSelect" class="form-select" onchange="updateValidationChart()">
                                    <option value="">Выберите модель...</option>
                                </select>
                            </div>
                            <div style="height: 500px; position: relative;">
                                <canvas id="validationChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Детализированная BI-аналитика валидации -->
                    <div id="detailedValidationCard" class="mt-4" style="display: none;">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>
                                    <span id="validationPivotModeTitle">Временные ряды</span>
                                </h6>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary active" id="validationTimeSeriesModeBtn" onclick="switchValidationPivotMode('time-series')">
                                        <i class="fas fa-clock me-1"></i>Временные ряды
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="validationSlicesModeBtn" onclick="switchValidationPivotMode('slices')">
                                        <i class="fas fa-layer-group me-1"></i>Срезы
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label" id="validationPrimaryFieldLabel">Метрики</label>
                                        <div class="dropdown">
                                            <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="validationPrimaryFieldDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                                <span id="validationPrimaryFieldDropdownText">Выберите метрики</span>
                                            </button>
                                            <ul class="dropdown-menu w-100" id="validationPrimaryFieldDropdownMenu">
                                                <li class="dropdown-item-text">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="validationSelectAllPrimary" onchange="toggleAllValidationPrimaryFields(this)">
                                                        <label class="form-check-label fw-bold" for="validationSelectAllPrimary">
                                                            Выбрать все
                                                        </label>
                                                    </div>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <div id="validationPrimaryFieldCheckboxes">
                                                    <!-- Чекбоксы будут добавлены динамически -->
                                                </div>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" id="validationSplitFieldLabel">Разбивка по срезам</label>
                                        <div class="dropdown">
                                            <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="validationSplitFieldDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                                <span id="validationSplitFieldDropdownText">Только временные ряды</span>
                                            </button>
                                            <ul class="dropdown-menu w-100" id="validationSplitFieldDropdownMenu">
                                                <li class="dropdown-item-text">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="validationSplitFieldSelection" id="validationNoSplitFieldSelection" value="" onchange="updateValidationSelectedSplitField()" checked>
                                                        <label class="form-check-label fw-bold" for="validationNoSplitFieldSelection">
                                                            <span id="validationNoSplitFieldText">Только временные ряды</span>
                                                        </label>
                                                    </div>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <div id="validationSplitFieldRadioButtons">
                                                    <!-- Радиокнопки будут добавлены динамически -->
                                                </div>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Секция фильтров -->
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <div class="card">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-filter me-2"></i>Фильтры
                                                </h6>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="resetValidationFilters()">
                                                    <i class="fas fa-undo me-1"></i>Сбросить все
                                                </button>
                                            </div>
                                            <div class="card-body">
                                                <div id="validationFiltersContainer">
                                                    <p class="text-muted text-center">Фильтры будут доступны после построения таблицы</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center">
                                    <button class="btn btn-primary" onclick="loadValidationData()">
                                        <i class="fas fa-chart-line me-2"></i>Построить таблицу
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <div id="timeSeriesChartContainer"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Кнопка перехода к прогнозу -->
                    <div class="text-center mb-4">
                        <button class="btn btn-secondary btn-lg me-3" onclick="goBack()">
                            <i class="fas fa-arrow-left me-2"></i>Изменить настройки
                        </button>
                        <button class="btn btn-success btn-lg" onclick="proceedToForecast()">
                            <i class="fas fa-rocket me-2"></i>Перейти к прогнозированию
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/breadcrumbs.js?v=20251018b"></script>
    <script src="/static/pivot_table_system.js"></script>
    <script>
        let currentSessionId = null;
        let forecastSettings = null;
        let trainingResults = null;
        let validationChartInstance = null;
        let selectedModels = ['random_forest', 'random_forest_hierarchy'];

        document.addEventListener('DOMContentLoaded', async function() {
            // Рендерим хлебные крошки (шаг 5 - Обучение моделей)
            breadcrumbsModule.render(5);
            
            const urlParams = new URLSearchParams(window.location.search);
            currentSessionId = urlParams.get('session_id') || 
                             sessionStorage.getItem('currentSessionId') ||
                             sessionStorage.getItem('sessionId');
            
            console.log('🆔 Session ID из URL:', urlParams.get('session_id'));
            console.log('🆔 Session ID из storage:', sessionStorage.getItem('currentSessionId'), sessionStorage.getItem('sessionId'));
            console.log('🆔 Итоговый currentSessionId:', currentSessionId);
            
            if (!currentSessionId) {
                console.error('❌ Session ID не найден!');
                alert('Сессия не найдена. Вернитесь на главную страницу и откройте проект.');
                window.location.href = '/';
                return;
            }
            
            // Сохраняем в оба ключа для совместимости
            sessionStorage.setItem('currentSessionId', currentSessionId);
            sessionStorage.setItem('sessionId', currentSessionId);
            
            await loadForecastSettings();
        });

        async function loadForecastSettings() {
            try {
                // Получаем сохраненные настройки прогноза
                const response = await fetch(`/api/get_forecast_settings/${currentSessionId}`);
                const result = await response.json();
                
                if (result.success) {
                    forecastSettings = result.settings;
                    displayForecastSettings();
                    
                    // Пытаемся загрузить результаты обучения если они есть
                    await loadTrainingResults();
                } else {
                    alert('Ошибка загрузки настроек: ' + result.message);
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка загрузки настроек: ' + error.message);
            }
        }
        
        async function loadTrainingResults() {
            console.log('🔍 loadTrainingResults() вызвана');
            try {
                // Проверяем есть ли сохраненные результаты обучения в проекте
                const projectId = sessionStorage.getItem('currentProjectId');
                console.log('   Project ID:', projectId);
                
                if (!projectId) {
                    console.log('   ⚠️ Project ID не найден, пропускаем загрузку результатов');
                    return;
                }
                
                console.log('   Загружаем проект...');
                const projectResponse = await fetch(`/api/load_project/${projectId}`);
                const projectData = await projectResponse.json();
                
                console.log('   Результат API:', projectData.success);
                console.log('   Проект:', projectData.project);
                console.log('   training_results в проекте:', projectData.project?.training_results);
                
                if (projectData.success && projectData.project.training_results) {
                    const savedResults = projectData.project.training_results;
                    console.log('✅ Найдены результаты обучения в проекте:', Object.keys(savedResults));
                    
                    // Восстанавливаем результаты (без моделей sklearn)
                    trainingResults = savedResults;
                    
                    console.log('   trainingResults установлен:', trainingResults);
                    console.log('   Вызываем displayTrainingResults()...');
                    
                    // Показываем результаты
                    displayTrainingResults();
                    
                    console.log('✅ Результаты обучения восстановлены');
                } else {
                    console.log('⚠️ training_results не найдены в проекте');
                }
            } catch (error) {
                console.error('❌ Ошибка загрузки результатов обучения:', error);
                console.error('   Детали:', error.message);
            }
        }

        function displayForecastSettings() {
            const infoDiv = document.getElementById('forecastSettingsInfo');
            
            if (!forecastSettings) {
                infoDiv.innerHTML = '<p class="text-muted">Настройки не найдены</p>';
                return;
            }
            
            const totalMonths = forecastSettings.forecast_months || 0;
            const metric = forecastSettings.metric || 'не указана';
            
            infoDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <p><strong>Метрика:</strong> ${metric}</p>
                    </div>
                    <div class="col-md-3">
                        <p><strong>Горизонт прогноза:</strong> ${totalMonths} месяцев</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Прогнозные периоды:</strong></p>
                        <div>
                            ${forecastSettings.forecast_periods.map(p => 
                                `<span class="badge bg-warning text-dark me-1">${p.year}: ${p.months.length} мес.</span>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function updateTestSizeLabel() {
            const slider = document.getElementById('testSizeSlider');
            const label = document.getElementById('testSizeLabel');
            const testSize = slider.value;
            const trainSize = 100 - testSize;
            
            label.textContent = `${testSize}%`;
            label.parentElement.querySelector('small').textContent = `Обучающая: ${trainSize}% | Контрольная: ${testSize}%`;
        }

        function toggleModel(modelId) {
            const checkbox = document.getElementById(`model_${modelId}`);
            checkbox.checked = !checkbox.checked;
            
            const card = checkbox.closest('.model-card');
            if (checkbox.checked) {
                card.classList.add('selected');
                if (!selectedModels.includes(modelId)) {
                    selectedModels.push(modelId);
                }
            } else {
                card.classList.remove('selected');
                selectedModels = selectedModels.filter(m => m !== modelId);
            }
        }

        async function trainModels() {
            const testSize = parseInt(document.getElementById('testSizeSlider').value);
            
            // Показываем статус обучения
            document.getElementById('trainingStatus').style.display = 'block';
            document.getElementById('trainingResults').style.display = 'none';
            
            try {
                // Получаем маппинг из sessionStorage
                const mappingData = sessionStorage.getItem('dataMapping');
                const mapping = mappingData ? JSON.parse(mappingData) : null;
                
                // Используем выбранные модели
                if (selectedModels.length === 0) {
                    alert('Выберите хотя бы одну модель для обучения');
                    document.getElementById('trainingStatus').style.display = 'none';
                    return;
                }
                
                console.log('🚀 Запуск обучения моделей:', selectedModels);
                
                const response = await fetch('/api/train_models', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        metric: forecastSettings.metric,
                        models: selectedModels,  // Используем выбранные модели
                        test_size: testSize / 100,
                        forecast_periods: forecastSettings.forecast_periods,
                        mapping: mapping
                    })
                });
                
                const result = await response.json();
                
                document.getElementById('trainingStatus').style.display = 'none';
                
                if (result.success) {
                    trainingResults = result.results;
                    displayTrainingResults();
                } else {
                    alert('❌ Ошибка обучения: ' + result.message);
                }
            } catch (error) {
                document.getElementById('trainingStatus').style.display = 'none';
                console.error('Ошибка:', error);
                alert('❌ Ошибка: ' + error.message);
            }
        }

        function displayTrainingResults() {
            document.getElementById('trainingResults').style.display = 'block';
            
            // Заполняем таблицу сравнения
            const tableBody = document.getElementById('modelsComparisonTable');
            const modelSelect = document.getElementById('modelSelect');
            
            tableBody.innerHTML = '';
            modelSelect.innerHTML = '<option value="">Выберите модель...</option>';
            
            // Сортируем модели по MAPE (лучшие первые)
            const sortedModels = Object.entries(trainingResults).sort((a, b) => {
                return a[1].metrics.mape - b[1].metrics.mape;
            });
            
            sortedModels.forEach(([modelName, data], index) => {
                const metrics = data.metrics;
                const rank = index + 1;
                const rankBadge = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : rank;
                
                // Определяем класс для MAPE
                let mapeClass = 'metric-good';
                if (metrics.mape > 20) mapeClass = 'metric-bad';
                else if (metrics.mape > 10) mapeClass = 'metric-medium';
                
                // Информация о срезах
                let sliceInfo = '';
                if (data.slices_count) {
                    const rangeText = data.metrics_range 
                        ? `(${data.metrics_range.mape_min.toFixed(1)}%-${data.metrics_range.mape_max.toFixed(1)}%)`
                        : '';
                    sliceInfo = `<br><small class="text-muted">Усреднено по ${data.slices_count} срезам ${rangeText}</small>`;
                }
                
                const row = `
                    <tr>
                        <td><strong>${getModelDisplayName(modelName)}</strong>${sliceInfo}</td>
                        <td>${metrics.mae.toLocaleString('ru-RU', {maximumFractionDigits: 2})}</td>
                        <td>${metrics.rmse.toLocaleString('ru-RU', {maximumFractionDigits: 2})}</td>
                        <td><span class="metric-badge ${mapeClass}">${metrics.mape.toFixed(2)}%</span></td>
                        <td><span class="fs-4">${rankBadge}</span></td>
                    </tr>
                `;
                
                tableBody.innerHTML += row;
                
                // Добавляем в select
                const option = document.createElement('option');
                option.value = modelName;
                option.text = `${getModelDisplayName(modelName)} (MAPE: ${metrics.mape.toFixed(2)}%)`;
                if (index === 0) {
                    option.selected = true;
                }
                modelSelect.appendChild(option);
            });
            
            // Отображаем график для лучшей модели
            if (sortedModels.length > 0) {
                updateValidationChart();
            }
        }

        function getModelDisplayName(modelName) {
            const names = {
                'arima': 'ARIMA',
                'prophet': 'Prophet',
                'random_forest': 'Random Forest',
                'random_forest_hierarchy': 'Random Forest Hierarchy',
                'linear_regression': 'Linear Regression',
                'xgboost': 'XGBoost'
            };
            return names[modelName] || modelName;
        }

        function updateValidationChart() {
            const select = document.getElementById('modelSelect');
            const selectedModel = select.value;
            
            if (!selectedModel || !trainingResults[selectedModel]) {
                return;
            }
            
            const modelData = trainingResults[selectedModel];
            const canvas = document.getElementById('validationChart');
            
            if (validationChartInstance) {
                validationChartInstance.destroy();
            }
            
            // Проверяем наличие данных для графика
            if (!modelData.validation_data || !modelData.validation_data.periods || modelData.validation_data.periods.length === 0) {
                console.warn('⚠️ Данные валидации отсутствуют для построения графика');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('Данные валидации не сохранены. Обучите модели заново для просмотра графика.', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const ctx = canvas.getContext('2d');
            validationChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: modelData.validation_data.periods,
                    datasets: [
                        {
                            label: 'Фактические значения',
                            data: modelData.validation_data.actual,
                            borderColor: '#2196F3',
                            backgroundColor: '#2196F333',
                            borderWidth: 4,
                            pointRadius: 6,
                            tension: 0.2,
                            fill: false
                        },
                        {
                            label: 'Прогноз модели',
                            data: modelData.validation_data.predicted,
                            borderColor: '#4CAF50',
                            backgroundColor: '#4CAF5033',
                            borderWidth: 4,
                            borderDash: [5, 5],
                            pointRadius: 6,
                            pointStyle: 'rect',
                            tension: 0.2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 2,
                    plugins: {
                        title: {
                            display: true,
                            text: `${getModelDisplayName(selectedModel)} - Валидация на контрольной выборке`,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    if (value === null) return null;
                                    return `${label}: ${value.toLocaleString('ru-RU', {maximumFractionDigits: 2})}`;
                                },
                                footer: function(tooltipItems) {
                                    if (tooltipItems.length >= 2) {
                                        const actual = tooltipItems[0].parsed.y;
                                        const predicted = tooltipItems[1].parsed.y;
                                        const error = Math.abs(actual - predicted);
                                        const errorPercent = (error / actual * 100).toFixed(2);
                                        return `Ошибка: ${error.toLocaleString('ru-RU', {maximumFractionDigits: 2})} (${errorPercent}%)`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Период (контрольная выборка)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: forecastSettings.metric
                            },
                            beginAtZero: false
                        }
                    }
                }
            });
            
            // Отображаем метрики для выбранной модели
            displayModelMetrics(selectedModel);
            
            // Отображаем детализированную таблицу
            renderDetailedValidationTable(selectedModel, modelData);
        }
        
        // Глобальные переменные для BI-интерфейса валидации
        let validationPivotMode = 'time-series';
        let validationSelectedMetrics = [];
        let validationSelectedSlices = [];
        let validationSplitField = null;
        
        function switchValidationPivotMode(mode) {
            validationPivotMode = mode;
            
            const titleElement = document.getElementById('validationPivotModeTitle');
            const iconElement = titleElement ? titleElement.previousElementSibling : null;
            const timeSeriesBtn = document.getElementById('validationTimeSeriesModeBtn');
            const slicesBtn = document.getElementById('validationSlicesModeBtn');
            
            if (mode === 'time-series') {
                if (titleElement) titleElement.textContent = 'Временные ряды';
                if (iconElement) iconElement.className = 'fas fa-clock me-2';
                if (timeSeriesBtn) {
                    timeSeriesBtn.classList.add('active');
                    slicesBtn.classList.remove('active');
                }
                document.getElementById('validationPrimaryFieldLabel').textContent = 'Метрики';
                document.getElementById('validationSplitFieldLabel').textContent = 'Разбивка по срезам';
            } else {
                if (titleElement) titleElement.textContent = 'Срезы';
                if (iconElement) iconElement.className = 'fas fa-layer-group me-2';
                if (slicesBtn) {
                    slicesBtn.classList.add('active');
                    timeSeriesBtn.classList.remove('active');
                }
                document.getElementById('validationPrimaryFieldLabel').textContent = 'Метрики';  // Остаются метрики!
                document.getElementById('validationSplitFieldLabel').textContent = 'Разбивка по временным рядам';
            }
            
            populateValidationSelects();
        }
        
        function populateValidationSelects() {
            const modelSelect = document.getElementById('modelSelect');
            const selectedModel = modelSelect ? modelSelect.value : 'random_forest';
            const modelData = trainingResults[selectedModel];
            
            if (!modelData || !modelData.detailed_validation) {
                return;
            }
            
            const detailedData = modelData.detailed_validation;
            const sliceCols = modelData.slice_cols || [];
            
            const primaryCheckboxes = document.getElementById('validationPrimaryFieldCheckboxes');
            const splitRadios = document.getElementById('validationSplitFieldRadioButtons');
            
            if (!primaryCheckboxes || !splitRadios) return;
            
            if (validationPivotMode === 'time-series') {
                const metricName = forecastSettings.metric;
                
                // Режим "Временные ряды": первичное поле = метрики (Факт, Прогноз)
                primaryCheckboxes.innerHTML = `
                    <li class="dropdown-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${metricName}_fact" id="validation_metric_fact" checked onchange="updateValidationSelectedMetrics()">
                            <label class="form-check-label" for="validation_metric_fact">${metricName} (Факт)</label>
                        </div>
                    </li>
                    <li class="dropdown-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${metricName}_predicted" id="validation_metric_predicted" checked onchange="updateValidationSelectedMetrics()">
                            <label class="form-check-label" for="validation_metric_predicted">${metricName} (Прогноз)</label>
                        </div>
                    </li>
                `;
                
                // Разбивка = срезы
                let splitHTML = '';
                sliceCols.forEach(slice => {
                    splitHTML += `
                        <li class="dropdown-item">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="validationSplitFieldSelection" value="${slice}" id="validation_split_${slice}" onchange="updateValidationSelectedSplitField()">
                                <label class="form-check-label" for="validation_split_${slice}">${slice}</label>
                            </div>
                        </li>
                    `;
                });
                splitRadios.innerHTML = splitHTML;
                
                validationSelectedMetrics = [`${metricName}_fact`, `${metricName}_predicted`];
            } else {
                const metricName = forecastSettings.metric;
                
                // Режим "Срезы": первичное поле = метрики (остаются!), разбивка = временные ряды
                primaryCheckboxes.innerHTML = `
                    <li class="dropdown-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${metricName}_fact" id="validation_metric_fact_slices" checked onchange="updateValidationSelectedMetrics()">
                            <label class="form-check-label" for="validation_metric_fact_slices">${metricName} (Факт)</label>
                        </div>
                    </li>
                    <li class="dropdown-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${metricName}_predicted" id="validation_metric_predicted_slices" checked onchange="updateValidationSelectedMetrics()">
                            <label class="form-check-label" for="validation_metric_predicted_slices">${metricName} (Прогноз)</label>
                        </div>
                    </li>
                `;
                
                // Разбивка = временные ряды (year, halfyear, quarter, month)
                const timeFields = [
                    { value: 'year', label: 'Год' },
                    { value: 'Halfyear', label: 'Полугодие' },
                    { value: 'Quarter', label: 'Квартал' },
                    { value: 'month', label: 'Месяц' }
                ];
                
                let splitHTML = '';
                timeFields.forEach(field => {
                    splitHTML += `
                        <li class="dropdown-item">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="validationSplitFieldSelection" value="${field.value}" id="validation_split_${field.value}" onchange="updateValidationSelectedSplitField()">
                                <label class="form-check-label" for="validation_split_${field.value}">${field.label}</label>
                            </div>
                        </li>
                    `;
                });
                splitRadios.innerHTML = splitHTML;
                
                validationSelectedMetrics = [`${metricName}_fact`, `${metricName}_predicted`];
            }
            
            updateValidationDropdownText();
        }
        
        function updateValidationSelectedMetrics() {
            validationSelectedMetrics = [];
            document.querySelectorAll('#validationPrimaryFieldCheckboxes input[type="checkbox"]:checked').forEach(cb => {
                validationSelectedMetrics.push(cb.value);
            });
            updateValidationDropdownText();
        }
        
        
        function updateValidationSelectedSplitField() {
            const selected = document.querySelector('input[name="validationSplitFieldSelection"]:checked');
            validationSplitField = selected ? selected.value : null;
            updateValidationDropdownText();
        }
        
        function updateValidationDropdownText() {
            const primaryText = document.getElementById('validationPrimaryFieldDropdownText');
            const splitText = document.getElementById('validationSplitFieldDropdownText');
            
            // В обоих режимах первичное поле = метрики
            const count = validationSelectedMetrics.length;
            primaryText.textContent = count > 0 ? `Выбрано метрик: ${count}` : 'Выберите метрики';
            
            if (validationPivotMode === 'time-series') {
                if (validationSplitField) {
                    splitText.textContent = validationSplitField;
                } else {
                    splitText.textContent = 'Только временные ряды';
                }
            } else {
                // Режим "Срезы": разбивка по временным рядам
                if (validationSplitField) {
                    const labels = {
                        'year': 'Год',
                        'Halfyear': 'Полугодие',
                        'Quarter': 'Квартал',
                        'month': 'Месяц'
                    };
                    splitText.textContent = labels[validationSplitField] || validationSplitField;
                } else {
                    splitText.textContent = 'Выберите временной ряд';
                }
            }
        }
        
        function toggleAllValidationPrimaryFields(checkbox) {
            const checkboxes = document.querySelectorAll('#validationPrimaryFieldCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateValidationSelectedMetrics();
        }
        
        function resetValidationFilters() {
            // TODO: Implement filter reset
            loadValidationData();
        }
        
        function loadValidationData() {
            const modelSelect = document.getElementById('modelSelect');
            const selectedModel = modelSelect ? modelSelect.value : 'random_forest';
            const modelData = trainingResults[selectedModel];
            
            if (!modelData || !modelData.detailed_validation) {
                alert('Нет данных для отображения');
                return;
            }
            
            const detailedData = modelData.detailed_validation;
            const sliceCols = modelData.slice_cols || [];
            const metricName = forecastSettings.metric;
            
            const mappingData = sessionStorage.getItem('dataMapping');
            let mapping = mappingData ? JSON.parse(mappingData) : null;
            
            if (!mapping) {
                alert('Ошибка: маппинг данных не найден');
                return;
            }
            
            // Создаем модифицированный маппинг для валидации
            const validationMapping = JSON.parse(JSON.stringify(mapping)); // deep copy
            
            console.log('📊 Исходный маппинг:', mapping);
            console.log('📊 Данные валидации (первая строка):', detailedData[0]);
            
            // Убираем старые метрики, добавляем новые для валидации
            validationMapping.columns = validationMapping.columns.filter(col => {
                // Оставляем только срезы и временные поля
                return (col.role === 'dimension') || (col.time_series && col.time_series !== '');
            });
            
            // Добавляем две метрики: факт и прогноз
            validationMapping.columns.push({
                name: `${metricName}_fact`,
                role: 'metric',
                include: validationSelectedMetrics.includes(`${metricName}_fact`)
            });
            
            validationMapping.columns.push({
                name: `${metricName}_predicted`,
                role: 'metric',
                include: validationSelectedMetrics.includes(`${metricName}_predicted`)
            });
            
            // Устанавливаем selectedMetrics
            validationMapping.selectedMetrics = validationSelectedMetrics.filter(m => 
                validationMapping.columns.find(col => col.name === m && col.role === 'metric')
            );
            
            console.log('📊 Модифицированный маппинг для валидации:', validationMapping);
            
            // Определяем режим: если есть разбивка - используем split-columns
            let renderMode = validationPivotMode;
            let originalMode = validationPivotMode;
            
            if (validationSplitField && validationSplitField !== '') {
                renderMode = 'split-columns';
                console.log('🔄 Выбрана разбивка - переключаем режим на split-columns');
            }
            
            console.log('📊 Параметры рендеринга:');
            console.log('   - renderMode:', renderMode);
            console.log('   - originalMode:', originalMode);
            console.log('   - splitBySlice:', validationSplitField || '(нет разбивки)');
            console.log('   - selectedMetrics:', validationSelectedMetrics);
            console.log('   - данных:', detailedData.length);
            
            // Используем renderNewPivotTable
            const container = document.getElementById('timeSeriesChartContainer');
            if (!container) {
                alert('Ошибка: контейнер не найден');
                return;
            }
            container.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p>Загрузка...</p></div>';
            
            setTimeout(() => {
                try {
                    if (typeof renderNewPivotTable === 'function') {
                        // Передаем 5 параметров: data, mapping, mode, splitBySlice, originalMode
                        const result = renderNewPivotTable(detailedData, validationMapping, renderMode, validationSplitField || '', originalMode);
                        console.log('✅ Таблица валидации отрендерена, результат:', result);
                    } else {
                        container.innerHTML = '<div class="alert alert-danger">Ошибка: функция renderNewPivotTable не найдена</div>';
                    }
                } catch (error) {
                    console.error('❌ Ошибка:', error);
                    console.error('Stack trace:', error.stack);
                    container.innerHTML = `<div class="alert alert-danger">Ошибка: ${error.message}</div>`;
                }
            }, 100);
        }
        
        function renderDetailedValidationTable(modelName, modelData) {
            const card = document.getElementById('detailedValidationCard');
            
            if (!modelData.detailed_validation || modelData.detailed_validation.length === 0) {
                console.warn('⚠️ Нет детализированных данных валидации');
                card.style.display = 'none';
                return;
            }
            
            console.log('📊 Детализированные данные валидации:', modelData.detailed_validation.length, 'строк');
            console.log('📊 Срезы:', modelData.slice_cols);
            console.log('📊 Первая строка:', modelData.detailed_validation[0]);
            
            // Показываем карточку с BI-интерфейсом
            card.style.display = 'block';
            
            // Инициализируем селекты и контролы
            populateValidationSelects();
            
            // Автоматически загружаем данные при первом показе
            setTimeout(() => {
                loadValidationData();
            }, 300);
        }

        function displayModelMetrics(modelName) {
            const modelData = trainingResults[modelName];
            // Можно добавить дополнительную информацию о модели
        }

        async function proceedToForecast() {
            if (!trainingResults) {
                alert('Сначала обучите модели');
                return;
            }
            
            // Получаем выбранную модель
            const select = document.getElementById('modelSelect');
            const selectedModel = select.value;
            
            if (!selectedModel) {
                alert('Выберите модель прогнозирования');
                return;
            }
            
            if (!confirm(`Построить прогноз с использованием модели ${getModelDisplayName(selectedModel)}?`)) {
                return;
            }
            
            // Сохраняем выбранную модель в sessionStorage
            sessionStorage.setItem('selectedForecastModel', selectedModel);
            
            // Сразу переходим на страницу результатов
            // Генерация прогноза запустится там с прогресс-баром
            window.location.href = `/forecast/results?session_id=${currentSessionId}&model=${selectedModel}`;
        }

        function goBack() {
            if (confirm('Вернуться к настройкам? Результаты обучения будут потеряны.')) {
                window.location.href = `/forecast/settings?session_id=${currentSessionId}`;
            }
        }
    </script>
</body>
</html>

