<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARFOR - –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/breadcrumbs.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .btn-primary {
            background-color: #81db99 !important;
            border-color: #81db99 !important;
            color: #000 !important;
        }
        
        .btn-primary:hover {
            background-color: #6bc884 !important;
        }
        
        .model-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .model-card:hover {
            border-color: #81db99;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .model-card.selected {
            border-color: #81db99;
            background: #f1f8f4;
        }
        
        .metric-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            margin: 3px;
            font-size: 0.9em;
        }
        
        .metric-good {
            background: #4caf50;
            color: white;
        }
        
        .metric-medium {
            background: #ff9800;
            color: white;
        }
        
        .metric-bad {
            background: #f44336;
            color: white;
        }
        
        .training-status {
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .training-status.running {
            background: #e3f2fd;
            border: 2px solid #2196f3;
        }
        
        .training-status.complete {
            background: #e8f5e9;
            border: 2px solid #4caf50;
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/forecast">
                <img src="/static/images/logo.png" alt="MARFOR Logo" height="32" class="me-2" style="object-fit: contain;">
                <strong>MARFOR</strong>
            </a>
            <span class="navbar-text">
                <i class="fas fa-brain me-2"></i>–û–±—É—á–µ–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
            </span>
            <div class="ms-auto">
                <span class="badge bg-success" style="font-size: 0.8em;">
                    <i class="fas fa-code"></i> v2.19.2
                </span>
            </div>
        </div>
    </nav>

    <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
    <div id="breadcrumbContainer"></div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è
                        </h6>
                    </div>
                    <div class="card-body" id="forecastSettingsInfo">
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </div>
                </div>

                <!-- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-database me-2"></i>–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –æ–±—É—á–∞—é—â—É—é –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é –≤—ã–±–æ—Ä–∫–∏
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">–†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –≤—ã–±–æ—Ä–∫–∏ (%):</label>
                                <input type="range" class="form-range" id="testSizeSlider" min="10" max="40" value="20" oninput="updateTestSizeLabel()">
                                <div class="text-center">
                                    <span id="testSizeLabel" class="badge bg-info">20%</span>
                                    <small class="text-muted d-block mt-2">–û–±—É—á–∞—é—â–∞—è: 80% | –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è: 20%</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>–û–±—É—á–∞—é—â–∞—è –≤—ã–±–æ—Ä–∫–∞</strong> - –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π<br>
                                    <strong>–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞</strong> - –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –í—ã–±–æ—Ä –º–æ–¥–µ–ª–µ–π -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-sliders-h me-2"></i>–í—ã–±–æ—Ä –º–æ–¥–µ–ª–µ–π –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ:</strong> Random Forest –æ–±—É—á–∞–µ—Ç—Å—è –Ω–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —Å—Ä–∞–∑—É, 
                            –∏—Å–ø–æ–ª—å–∑—É—è —Å—Ä–µ–∑—ã (—Ä–µ–≥–∏–æ–Ω—ã, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è) –∫–∞–∫ –ø—Ä–∏–∑–Ω–∞–∫–∏. –≠—Ç–æ –±—ã—Å—Ç—Ä–æ –∏ —Ç–æ—á–Ω–æ!
                        </div>
                        
                        <div class="row justify-content-center">
                            <!-- Random Forest -->
                            <div class="col-md-8">
                                <div class="model-card active">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="model_random_forest" checked disabled>
                                        <label class="form-check-label fw-bold" for="model_random_forest">
                                            <i class="fas fa-tree me-2"></i>Random Forest
                                        </label>
                                    </div>
                                    <small class="text-muted">–ê–Ω—Å–∞–º–±–ª—å –¥–µ—Ä–µ–≤—å–µ–≤ —Ä–µ—à–µ–Ω–∏–π. –û—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏ –∏ –±–æ–ª—å—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏.</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <button class="btn btn-success btn-lg" onclick="trainModels()">
                                <i class="fas fa-play me-2"></i>–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
                            </button>
                        </div>
                    </div>
                </div>

                <!-- –°—Ç–∞—Ç—É—Å –æ–±—É—á–µ–Ω–∏—è -->
                <div id="trainingStatus" style="display: none;">
                    <div class="training-status running">
                        <div class="spinner-border text-primary me-3" role="status">
                            <span class="visually-hidden">–û–±—É—á–µ–Ω–∏–µ...</span>
                        </div>
                        <span class="fs-5">–û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π...</span>
                        <div id="trainingProgress" class="mt-2"></div>
                    </div>
                </div>

                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è -->
                <div id="trainingResults" style="display: none;">
                    <div class="card mb-3">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-check-circle me-2"></i>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- –¢–∞–±–ª–∏—Ü–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π -->
                            <h6 class="mb-3">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π:</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>–ú–æ–¥–µ–ª—å</th>
                                            <th>MAE<br><small>(—Å—Ä–µ–¥–Ω—è—è –∞–±—Å–æ–ª—é—Ç–Ω–∞—è –æ—à–∏–±–∫–∞)</small></th>
                                            <th>RMSE<br><small>(–∫–æ—Ä–µ–Ω—å –∏–∑ —Å—Ä–µ–¥–Ω–µ–π –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ–π)</small></th>
                                            <th>MAPE, %<br><small>(—Å—Ä–µ–¥–Ω—è—è –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è –æ—à–∏–±–∫–∞)</small></th>
                                            <th>–†–µ–π—Ç–∏–Ω–≥</th>
                                        </tr>
                                    </thead>
                                    <tbody id="modelsComparisonTable">
                                        <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- –ì—Ä–∞—Ñ–∏–∫: –§–∞–∫—Ç vs –ü—Ä–æ–≥–Ω–æ–∑ -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-dark">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-area me-2"></i>–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –≤—ã–±–æ—Ä–∫–µ
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
                                <select id="modelSelect" class="form-select" onchange="updateValidationChart()">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å...</option>
                                </select>
                            </div>
                            <div style="height: 500px; position: relative;">
                                <canvas id="validationChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ -->
                    <div class="card mt-4" id="detailedValidationCard" style="display: none;">
                        <div class="card-header bg-info text-dark">
                            <h6 class="mb-0">
                                <i class="fas fa-table me-2"></i>–î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ —Å—Ä–µ–∑–∞–º
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="validationPivotTableContainer"></div>
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –ø—Ä–æ–≥–Ω–æ–∑—É -->
                    <div class="text-center mb-4">
                        <button class="btn btn-secondary btn-lg me-3" onclick="goBack()">
                            <i class="fas fa-arrow-left me-2"></i>–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                        </button>
                        <button class="btn btn-success btn-lg" onclick="proceedToForecast()">
                            <i class="fas fa-rocket me-2"></i>–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—é
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/breadcrumbs.js"></script>
    <script src="/static/pivot_table_system.js"></script>
    <script>
        let currentSessionId = null;
        let forecastSettings = null;
        let trainingResults = null;
        let validationChartInstance = null;
        let selectedModels = ['arima', 'prophet', 'random_forest'];

        document.addEventListener('DOMContentLoaded', async function() {
            // –†–µ–Ω–¥–µ—Ä–∏–º —Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ (—à–∞–≥ 4 - –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π)
            breadcrumbsModule.render(5); // –®–∞–≥ 5 - –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
            
            const urlParams = new URLSearchParams(window.location.search);
            currentSessionId = urlParams.get('session_id') || sessionStorage.getItem('currentSessionId');
            
            if (!currentSessionId) {
                alert('–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                window.location.href = '/forecast';
                return;
            }
            
            await loadForecastSettings();
        });

        async function loadForecastSettings() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞
                const response = await fetch(`/api/get_forecast_settings/${currentSessionId}`);
                const result = await response.json();
                
                if (result.success) {
                    forecastSettings = result.settings;
                    displayForecastSettings();
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + result.message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + error.message);
            }
        }

        function displayForecastSettings() {
            const infoDiv = document.getElementById('forecastSettingsInfo');
            
            if (!forecastSettings) {
                infoDiv.innerHTML = '<p class="text-muted">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }
            
            const totalMonths = forecastSettings.forecast_months || 0;
            const metric = forecastSettings.metric || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞';
            
            infoDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <p><strong>–ú–µ—Ç—Ä–∏–∫–∞:</strong> ${metric}</p>
                    </div>
                    <div class="col-md-3">
                        <p><strong>–ì–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞:</strong> ${totalMonths} –º–µ—Å—è—Ü–µ–≤</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>–ü—Ä–æ–≥–Ω–æ–∑–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã:</strong></p>
                        <div>
                            ${forecastSettings.forecast_periods.map(p => 
                                `<span class="badge bg-warning text-dark me-1">${p.year}: ${p.months.length} –º–µ—Å.</span>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function updateTestSizeLabel() {
            const slider = document.getElementById('testSizeSlider');
            const label = document.getElementById('testSizeLabel');
            const testSize = slider.value;
            const trainSize = 100 - testSize;
            
            label.textContent = `${testSize}%`;
            label.parentElement.querySelector('small').textContent = `–û–±—É—á–∞—é—â–∞—è: ${trainSize}% | –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è: ${testSize}%`;
        }

        function toggleModel(modelId) {
            const checkbox = document.getElementById(`model_${modelId}`);
            checkbox.checked = !checkbox.checked;
            
            const card = checkbox.closest('.model-card');
            if (checkbox.checked) {
                card.classList.add('selected');
                if (!selectedModels.includes(modelId)) {
                    selectedModels.push(modelId);
                }
            } else {
                card.classList.remove('selected');
                selectedModels = selectedModels.filter(m => m !== modelId);
            }
        }

        async function trainModels() {
            const testSize = parseInt(document.getElementById('testSizeSlider').value);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ–±—É—á–µ–Ω–∏—è
            document.getElementById('trainingStatus').style.display = 'block';
            document.getElementById('trainingResults').style.display = 'none';
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –º–∞–ø–ø–∏–Ω–≥ –∏–∑ sessionStorage
                const mappingData = sessionStorage.getItem('dataMapping');
                const mapping = mappingData ? JSON.parse(mappingData) : null;
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ Random Forest
                const modelsToTrain = ['random_forest'];
                
                const response = await fetch('/api/train_models', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        metric: forecastSettings.metric,
                        models: modelsToTrain,
                        test_size: testSize / 100,
                        forecast_periods: forecastSettings.forecast_periods,
                        mapping: mapping
                    })
                });
                
                const result = await response.json();
                
                document.getElementById('trainingStatus').style.display = 'none';
                
                if (result.success) {
                    trainingResults = result.results;
                    displayTrainingResults();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –æ–±—É—á–µ–Ω–∏—è: ' + result.message);
                }
            } catch (error) {
                document.getElementById('trainingStatus').style.display = 'none';
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function displayTrainingResults() {
            document.getElementById('trainingResults').style.display = 'block';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            const tableBody = document.getElementById('modelsComparisonTable');
            const modelSelect = document.getElementById('modelSelect');
            
            tableBody.innerHTML = '';
            modelSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å...</option>';
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ –ø–æ MAPE (–ª—É—á—à–∏–µ –ø–µ—Ä–≤—ã–µ)
            const sortedModels = Object.entries(trainingResults).sort((a, b) => {
                return a[1].metrics.mape - b[1].metrics.mape;
            });
            
            sortedModels.forEach(([modelName, data], index) => {
                const metrics = data.metrics;
                const rank = index + 1;
                const rankBadge = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è MAPE
                let mapeClass = 'metric-good';
                if (metrics.mape > 20) mapeClass = 'metric-bad';
                else if (metrics.mape > 10) mapeClass = 'metric-medium';
                
                // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ä–µ–∑–∞—Ö
                let sliceInfo = '';
                if (data.slices_count) {
                    const rangeText = data.metrics_range 
                        ? `(${data.metrics_range.mape_min.toFixed(1)}%-${data.metrics_range.mape_max.toFixed(1)}%)`
                        : '';
                    sliceInfo = `<br><small class="text-muted">–£—Å—Ä–µ–¥–Ω–µ–Ω–æ –ø–æ ${data.slices_count} —Å—Ä–µ–∑–∞–º ${rangeText}</small>`;
                }
                
                const row = `
                    <tr>
                        <td><strong>${getModelDisplayName(modelName)}</strong>${sliceInfo}</td>
                        <td>${metrics.mae.toLocaleString('ru-RU', {maximumFractionDigits: 2})}</td>
                        <td>${metrics.rmse.toLocaleString('ru-RU', {maximumFractionDigits: 2})}</td>
                        <td><span class="metric-badge ${mapeClass}">${metrics.mape.toFixed(2)}%</span></td>
                        <td><span class="fs-4">${rankBadge}</span></td>
                    </tr>
                `;
                
                tableBody.innerHTML += row;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ select
                const option = document.createElement('option');
                option.value = modelName;
                option.text = `${getModelDisplayName(modelName)} (MAPE: ${metrics.mape.toFixed(2)}%)`;
                if (index === 0) {
                    option.selected = true;
                }
                modelSelect.appendChild(option);
            });
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏
            if (sortedModels.length > 0) {
                updateValidationChart();
            }
        }

        function getModelDisplayName(modelName) {
            const names = {
                'arima': 'ARIMA',
                'prophet': 'Prophet',
                'random_forest': 'Random Forest',
                'linear_regression': 'Linear Regression',
                'xgboost': 'XGBoost'
            };
            return names[modelName] || modelName;
        }

        function updateValidationChart() {
            const select = document.getElementById('modelSelect');
            const selectedModel = select.value;
            
            if (!selectedModel || !trainingResults[selectedModel]) {
                return;
            }
            
            const modelData = trainingResults[selectedModel];
            const canvas = document.getElementById('validationChart');
            
            if (validationChartInstance) {
                validationChartInstance.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            validationChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: modelData.validation_data.periods,
                    datasets: [
                        {
                            label: '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è',
                            data: modelData.validation_data.actual,
                            borderColor: '#2196F3',
                            backgroundColor: '#2196F333',
                            borderWidth: 4,
                            pointRadius: 6,
                            tension: 0.2,
                            fill: false
                        },
                        {
                            label: '–ü—Ä–æ–≥–Ω–æ–∑ –º–æ–¥–µ–ª–∏',
                            data: modelData.validation_data.predicted,
                            borderColor: '#4CAF50',
                            backgroundColor: '#4CAF5033',
                            borderWidth: 4,
                            borderDash: [5, 5],
                            pointRadius: 6,
                            pointStyle: 'rect',
                            tension: 0.2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 2,
                    plugins: {
                        title: {
                            display: true,
                            text: `${getModelDisplayName(selectedModel)} - –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –≤—ã–±–æ—Ä–∫–µ`,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    if (value === null) return null;
                                    return `${label}: ${value.toLocaleString('ru-RU', {maximumFractionDigits: 2})}`;
                                },
                                footer: function(tooltipItems) {
                                    if (tooltipItems.length >= 2) {
                                        const actual = tooltipItems[0].parsed.y;
                                        const predicted = tooltipItems[1].parsed.y;
                                        const error = Math.abs(actual - predicted);
                                        const errorPercent = (error / actual * 100).toFixed(2);
                                        return `–û—à–∏–±–∫–∞: ${error.toLocaleString('ru-RU', {maximumFractionDigits: 2})} (${errorPercent}%)`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '–ü–µ—Ä–∏–æ–¥ (–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: forecastSettings.metric
                            },
                            beginAtZero: false
                        }
                    }
                }
            });
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
            displayModelMetrics(selectedModel);
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
            renderDetailedValidationTable(selectedModel, modelData);
        }
        
        function renderDetailedValidationTable(modelName, modelData) {
            const card = document.getElementById('detailedValidationCard');
            const container = document.getElementById('validationPivotTableContainer');
            
            if (!modelData.detailed_validation || modelData.detailed_validation.length === 0) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
            const detailedData = modelData.detailed_validation;
            const sliceCols = modelData.slice_cols || [];
            
            console.log('–î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', detailedData.length, '—Å—Ç—Ä–æ–∫');
            console.log('–°—Ä–µ–∑—ã:', sliceCols);
            console.log('–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞:', detailedData[0]);
            
            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è pivot table —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∂–∏–º time-series, –≥–¥–µ –ø–µ—Ä–∏–æ–¥ - —ç—Ç–æ —Å—Ç–æ–ª–±—Ü—ã
            const rowFields = [];
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è —Å—Ä–µ–∑–æ–≤ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏
            sliceCols.forEach((sliceCol, index) => {
                rowFields.push(new PivotField(sliceCol, sliceCol, 'slice', index));
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º metric_type (–§–∞–∫—Ç/–ü—Ä–æ–≥–Ω–æ–∑) –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ–ª–µ –≤ —Å—Ç—Ä–æ–∫–∞—Ö
            rowFields.push(new PivotField('metric_type', '–¢–∏–ø', 'slice', sliceCols.length));
            
            // –ü–µ—Ä–∏–æ–¥ –±—É–¥–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–π –æ—Å—å—é (–ø–æ —Å—Ç–æ–ª–±—Ü–∞–º)
            const timeField = new PivotField('period', '–ü–µ—Ä–∏–æ–¥', 'time');
            
            // –ú–µ—Ç—Ä–∏–∫–∞ - —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ revenue (–±—É–¥–µ—Ç –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –º–µ—Ç—Ä–∏–∫–∏)
            const metricFields = [
                new PivotField(metric, metric, 'metric')
            ];
            
            const pivotConfig = new PivotConfig(rowFields, metricFields, timeField, 'time-series');
            
            // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É
            container.innerHTML = '<div class="text-center"><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>';
            
            setTimeout(() => {
                try {
                    const pivotData = new PivotData(detailedData, pivotConfig);
                    const renderer = new PivotRenderer('validationPivotTableContainer');
                    const tableHTML = renderer.render(pivotData, pivotConfig);
                    console.log('‚úÖ –¢–∞–±–ª–∏—Ü–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ç–∞–±–ª–∏—Ü—ã:', error);
                    container.innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã: ${error.message}</div>`;
                }
            }, 100);
        }

        function displayModelMetrics(modelName) {
            const modelData = trainingResults[modelName];
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥–µ–ª–∏
        }

        async function proceedToForecast() {
            if (!trainingResults) {
                alert('–°–Ω–∞—á–∞–ª–∞ –æ–±—É—á–∏—Ç–µ –º–æ–¥–µ–ª–∏');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å
            const select = document.getElementById('modelSelect');
            const selectedModel = select.value;
            
            if (!selectedModel) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }
            
            if (!confirm(`–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–æ–¥–µ–ª–∏ ${getModelDisplayName(selectedModel)}?`)) {
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –º–∞–ø–ø–∏–Ω–≥ –∏–∑ sessionStorage
                const mappingData = sessionStorage.getItem('dataMapping');
                const mapping = mappingData ? JSON.parse(mappingData) : null;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–∞
                const response = await fetch('/api/generate_forecast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        model: selectedModel,
                        mapping: mapping  // –ü–µ—Ä–µ–¥–∞–µ–º –º–∞–ø–ø–∏–Ω–≥
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≥–Ω–æ–∑–∞
                    window.location.href = `/forecast/results?session_id=${currentSessionId}`;
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –ø—Ä–æ–≥–Ω–æ–∑–∞: ' + result.message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function goBack() {
            if (confirm('–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º? –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                window.location.href = `/forecast/settings?session_id=${currentSessionId}`;
            }
        }
    </script>
</body>
</html>

