<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARFOR - –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/breadcrumbs.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .btn-primary {
            background-color: #81db99 !important;
            border-color: #81db99 !important;
            color: #000 !important;
        }
        
        .btn-primary:hover {
            background-color: #6bc884 !important;
        }
        
        .model-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .model-card:hover {
            border-color: #81db99;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .model-card.selected {
            border-color: #81db99;
            background: #f1f8f4;
        }
        
        .metric-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            margin: 3px;
            font-size: 0.9em;
        }
        
        .metric-good {
            background: #4caf50;
            color: white;
        }
        
        .metric-medium {
            background: #ff9800;
            color: white;
        }
        
        .metric-bad {
            background: #f44336;
            color: white;
        }
        
        .training-status {
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .training-status.running {
            background: #e3f2fd;
            border: 2px solid #2196f3;
        }
        
        .training-status.complete {
            background: #e8f5e9;
            border: 2px solid #4caf50;
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/forecast">
                <img src="/static/images/logo.png" alt="MARFOR Logo" height="32" class="me-2" style="object-fit: contain;">
                <strong>MARFOR</strong>
            </a>
            <span class="navbar-text">
                <i class="fas fa-brain me-2"></i>–û–±—É—á–µ–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
            </span>
            <div class="ms-auto">
                <span class="badge bg-success" style="font-size: 0.8em;">
                    <i class="fas fa-code"></i> v2.19.2
                </span>
            </div>
        </div>
    </nav>

    <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
    <div id="breadcrumbContainer"></div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è
                        </h6>
                    </div>
                    <div class="card-body" id="forecastSettingsInfo">
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </div>
                </div>

                <!-- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-database me-2"></i>–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –æ–±—É—á–∞—é—â—É—é –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é –≤—ã–±–æ—Ä–∫–∏
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">–†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –≤—ã–±–æ—Ä–∫–∏ (%):</label>
                                <input type="range" class="form-range" id="testSizeSlider" min="10" max="40" value="20" oninput="updateTestSizeLabel()">
                                <div class="text-center">
                                    <span id="testSizeLabel" class="badge bg-info">20%</span>
                                    <small class="text-muted d-block mt-2">–û–±—É—á–∞—é—â–∞—è: 80% | –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è: 20%</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>–û–±—É—á–∞—é—â–∞—è –≤—ã–±–æ—Ä–∫–∞</strong> - –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π<br>
                                    <strong>–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞</strong> - –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –í—ã–±–æ—Ä –º–æ–¥–µ–ª–µ–π -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-sliders-h me-2"></i>–í—ã–±–æ—Ä –º–æ–¥–µ–ª–µ–π –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>–î–≤–µ –º–æ–¥–µ–ª–∏ Random Forest:</strong> –ë–∞–∑–æ–≤–∞—è (–±—ã—Å—Ç—Ä–∞—è) –∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Å –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–º —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ–º, 
                            –ª–∞–≥–∞–º–∏, rolling-–ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏ –∏ —Å–µ–∑–æ–Ω–Ω—ã–º–∏ —Å–∏–Ω—É—Å–æ–∏–¥–∞–º–∏. –í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è!
                        </div>
                        
                        <div class="row">
                            <!-- Random Forest (–±–∞–∑–æ–≤–∞—è) -->
                            <div class="col-md-6">
                                <div class="model-card" onclick="toggleModel('random_forest')">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="model_random_forest" checked>
                                        <label class="form-check-label fw-bold" for="model_random_forest">
                                            <i class="fas fa-tree me-2"></i>Random Forest
                                        </label>
                                    </div>
                                    <small class="text-muted">
                                        –ë–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å. –ü—Ä–∏–∑–Ω–∞–∫–∏: year, month, —Å—Ä–µ–∑—ã (–∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ). –ë—ã—Å—Ç—Ä–∞—è –∏ –ø—Ä–æ—Å—Ç–∞—è.
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Random Forest Hierarchy (–ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è) -->
                            <div class="col-md-6">
                                <div class="model-card" onclick="toggleModel('random_forest_hierarchy')">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="model_random_forest_hierarchy" checked>
                                        <label class="form-check-label fw-bold" for="model_random_forest_hierarchy">
                                            <i class="fas fa-project-diagram me-2"></i>Random Forest Hierarchy
                                        </label>
                                    </div>
                                    <small class="text-muted">
                                        –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –º–æ–¥–µ–ª—å. –õ–∞–≥–∏ (1,2,3,4,6,12), rolling (mean/std/min/max), —Å–µ–∑–æ–Ω–Ω—ã–µ —Å–∏–Ω—É—Å–æ–∏–¥—ã, –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ.
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <button class="btn btn-success btn-lg" onclick="trainModels()">
                                <i class="fas fa-play me-2"></i>–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
                            </button>
                        </div>
                    </div>
                </div>

                <!-- –°—Ç–∞—Ç—É—Å –æ–±—É—á–µ–Ω–∏—è -->
                <div id="trainingStatus" style="display: none;">
                    <div class="training-status running">
                        <div class="spinner-border text-primary me-3" role="status">
                            <span class="visually-hidden">–û–±—É—á–µ–Ω–∏–µ...</span>
                        </div>
                        <span class="fs-5">–û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π...</span>
                        <div id="trainingProgress" class="mt-2"></div>
                    </div>
                </div>

                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è -->
                <div id="trainingResults" style="display: none;">
                    <div class="card mb-3">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-check-circle me-2"></i>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- –¢–∞–±–ª–∏—Ü–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π -->
                            <h6 class="mb-3">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π:</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>–ú–æ–¥–µ–ª—å</th>
                                            <th>MAE<br><small>(—Å—Ä–µ–¥–Ω—è—è –∞–±—Å–æ–ª—é—Ç–Ω–∞—è –æ—à–∏–±–∫–∞)</small></th>
                                            <th>RMSE<br><small>(–∫–æ—Ä–µ–Ω—å –∏–∑ —Å—Ä–µ–¥–Ω–µ–π –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ–π)</small></th>
                                            <th>MAPE, %<br><small>(—Å—Ä–µ–¥–Ω—è—è –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è –æ—à–∏–±–∫–∞)</small></th>
                                            <th>–†–µ–π—Ç–∏–Ω–≥</th>
                                        </tr>
                                    </thead>
                                    <tbody id="modelsComparisonTable">
                                        <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- –ì—Ä–∞—Ñ–∏–∫: –§–∞–∫—Ç vs –ü—Ä–æ–≥–Ω–æ–∑ -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-dark">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-area me-2"></i>–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –≤—ã–±–æ—Ä–∫–µ
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
                                <select id="modelSelect" class="form-select" onchange="updateValidationChart()">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å...</option>
                                </select>
                            </div>
                            <div style="height: 500px; position: relative;">
                                <canvas id="validationChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è BI-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ -->
                    <div id="detailedValidationCard" class="mt-4" style="display: none;">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>
                                    <span id="validationPivotModeTitle">–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã</span>
                                </h6>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary active" id="validationTimeSeriesModeBtn" onclick="switchValidationPivotMode('time-series')">
                                        <i class="fas fa-clock me-1"></i>–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="validationSlicesModeBtn" onclick="switchValidationPivotMode('slices')">
                                        <i class="fas fa-layer-group me-1"></i>–°—Ä–µ–∑—ã
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label" id="validationPrimaryFieldLabel">–ú–µ—Ç—Ä–∏–∫–∏</label>
                                        <div class="dropdown">
                                            <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="validationPrimaryFieldDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                                <span id="validationPrimaryFieldDropdownText">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç—Ä–∏–∫–∏</span>
                                            </button>
                                            <ul class="dropdown-menu w-100" id="validationPrimaryFieldDropdownMenu">
                                                <li class="dropdown-item-text">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="validationSelectAllPrimary" onchange="toggleAllValidationPrimaryFields(this)">
                                                        <label class="form-check-label fw-bold" for="validationSelectAllPrimary">
                                                            –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                                                        </label>
                                                    </div>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <div id="validationPrimaryFieldCheckboxes">
                                                    <!-- –ß–µ–∫–±–æ–∫—Å—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                                </div>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" id="validationSplitFieldLabel">–†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Å—Ä–µ–∑–∞–º</label>
                                        <div class="dropdown">
                                            <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="validationSplitFieldDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                                <span id="validationSplitFieldDropdownText">–¢–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã</span>
                                            </button>
                                            <ul class="dropdown-menu w-100" id="validationSplitFieldDropdownMenu">
                                                <li class="dropdown-item-text">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="validationSplitFieldSelection" id="validationNoSplitFieldSelection" value="" onchange="updateValidationSelectedSplitField()" checked>
                                                        <label class="form-check-label fw-bold" for="validationNoSplitFieldSelection">
                                                            <span id="validationNoSplitFieldText">–¢–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã</span>
                                                        </label>
                                                    </div>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <div id="validationSplitFieldRadioButtons">
                                                    <!-- –†–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                                </div>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- –°–µ–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <div class="card">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-filter me-2"></i>–§–∏–ª—å—Ç—Ä—ã
                                                </h6>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="resetValidationFilters()">
                                                    <i class="fas fa-undo me-1"></i>–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ
                                                </button>
                                            </div>
                                            <div class="card-body">
                                                <div id="validationFiltersContainer">
                                                    <p class="text-muted text-center">–§–∏–ª—å—Ç—Ä—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center">
                                    <button class="btn btn-primary" onclick="loadValidationData()">
                                        <i class="fas fa-chart-line me-2"></i>–ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <div id="timeSeriesChartContainer"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –ø—Ä–æ–≥–Ω–æ–∑—É -->
                    <div class="text-center mb-4">
                        <button class="btn btn-secondary btn-lg me-3" onclick="goBack()">
                            <i class="fas fa-arrow-left me-2"></i>–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                        </button>
                        <button class="btn btn-success btn-lg" onclick="proceedToForecast()">
                            <i class="fas fa-rocket me-2"></i>–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—é
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/breadcrumbs.js?v=20251018b"></script>
    <script src="/static/pivot_table_system.js"></script>
    <script>
        let currentSessionId = null;
        let forecastSettings = null;
        let trainingResults = null;
        let validationChartInstance = null;
        let selectedModels = ['random_forest', 'random_forest_hierarchy'];

        document.addEventListener('DOMContentLoaded', async function() {
            // –†–µ–Ω–¥–µ—Ä–∏–º —Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ (—à–∞–≥ 5 - –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π)
            breadcrumbsModule.render(5);
            
            const urlParams = new URLSearchParams(window.location.search);
            currentSessionId = urlParams.get('session_id') || 
                             sessionStorage.getItem('currentSessionId') ||
                             sessionStorage.getItem('sessionId');
            
            console.log('üÜî Session ID –∏–∑ URL:', urlParams.get('session_id'));
            console.log('üÜî Session ID –∏–∑ storage:', sessionStorage.getItem('currentSessionId'), sessionStorage.getItem('sessionId'));
            console.log('üÜî –ò—Ç–æ–≥–æ–≤—ã–π currentSessionId:', currentSessionId);
            
            if (!currentSessionId) {
                console.error('‚ùå Session ID –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                alert('–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ–µ–∫—Ç.');
                window.location.href = '/';
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±–∞ –∫–ª—é—á–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            sessionStorage.setItem('currentSessionId', currentSessionId);
            sessionStorage.setItem('sessionId', currentSessionId);
            
            await loadForecastSettings();
        });

        async function loadForecastSettings() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞
                const response = await fetch(`/api/get_forecast_settings/${currentSessionId}`);
                const result = await response.json();
                
                if (result.success) {
                    forecastSettings = result.settings;
                    displayForecastSettings();
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    await loadTrainingResults();
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + result.message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + error.message);
            }
        }
        
        async function loadTrainingResults() {
            console.log('üîç loadTrainingResults() –≤—ã–∑–≤–∞–Ω–∞');
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è –≤ –ø—Ä–æ–µ–∫—Ç–µ
                const projectId = sessionStorage.getItem('currentProjectId');
                console.log('   Project ID:', projectId);
                
                if (!projectId) {
                    console.log('   ‚ö†Ô∏è Project ID –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤');
                    return;
                }
                
                console.log('   –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–µ–∫—Ç...');
                const projectResponse = await fetch(`/api/load_project/${projectId}`);
                const projectData = await projectResponse.json();
                
                console.log('   –†–µ–∑—É–ª—å—Ç–∞—Ç API:', projectData.success);
                console.log('   –ü—Ä–æ–µ–∫—Ç:', projectData.project);
                console.log('   training_results –≤ –ø—Ä–æ–µ–∫—Ç–µ:', projectData.project?.training_results);
                
                if (projectData.success && projectData.project.training_results) {
                    const savedResults = projectData.project.training_results;
                    console.log('‚úÖ –ù–∞–π–¥–µ–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è –≤ –ø—Ä–æ–µ–∫—Ç–µ:', Object.keys(savedResults));
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–±–µ–∑ –º–æ–¥–µ–ª–µ–π sklearn)
                    trainingResults = savedResults;
                    
                    console.log('   trainingResults —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', trainingResults);
                    console.log('   –í—ã–∑—ã–≤–∞–µ–º displayTrainingResults()...');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    displayTrainingResults();
                    
                    console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
                } else {
                    console.log('‚ö†Ô∏è training_results –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—É—á–µ–Ω–∏—è:', error);
                console.error('   –î–µ—Ç–∞–ª–∏:', error.message);
            }
        }

        function displayForecastSettings() {
            const infoDiv = document.getElementById('forecastSettingsInfo');
            
            if (!forecastSettings) {
                infoDiv.innerHTML = '<p class="text-muted">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }
            
            const totalMonths = forecastSettings.forecast_months || 0;
            const metric = forecastSettings.metric || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞';
            
            infoDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <p><strong>–ú–µ—Ç—Ä–∏–∫–∞:</strong> ${metric}</p>
                    </div>
                    <div class="col-md-3">
                        <p><strong>–ì–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞:</strong> ${totalMonths} –º–µ—Å—è—Ü–µ–≤</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>–ü—Ä–æ–≥–Ω–æ–∑–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã:</strong></p>
                        <div>
                            ${forecastSettings.forecast_periods.map(p => 
                                `<span class="badge bg-warning text-dark me-1">${p.year}: ${p.months.length} –º–µ—Å.</span>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function updateTestSizeLabel() {
            const slider = document.getElementById('testSizeSlider');
            const label = document.getElementById('testSizeLabel');
            const testSize = slider.value;
            const trainSize = 100 - testSize;
            
            label.textContent = `${testSize}%`;
            label.parentElement.querySelector('small').textContent = `–û–±—É—á–∞—é—â–∞—è: ${trainSize}% | –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è: ${testSize}%`;
        }

        function toggleModel(modelId) {
            const checkbox = document.getElementById(`model_${modelId}`);
            checkbox.checked = !checkbox.checked;
            
            const card = checkbox.closest('.model-card');
            if (checkbox.checked) {
                card.classList.add('selected');
                if (!selectedModels.includes(modelId)) {
                    selectedModels.push(modelId);
                }
            } else {
                card.classList.remove('selected');
                selectedModels = selectedModels.filter(m => m !== modelId);
            }
        }

        async function trainModels() {
            const testSize = parseInt(document.getElementById('testSizeSlider').value);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ–±—É—á–µ–Ω–∏—è
            document.getElementById('trainingStatus').style.display = 'block';
            document.getElementById('trainingResults').style.display = 'none';
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –º–∞–ø–ø–∏–Ω–≥ –∏–∑ sessionStorage
                const mappingData = sessionStorage.getItem('dataMapping');
                const mapping = mappingData ? JSON.parse(mappingData) : null;
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏
                if (selectedModels.length === 0) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –º–æ–¥–µ–ª—å –¥–ª—è –æ–±—É—á–µ–Ω–∏—è');
                    document.getElementById('trainingStatus').style.display = 'none';
                    return;
                }
                
                console.log('üöÄ –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π:', selectedModels);
                
                const response = await fetch('/api/train_models', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        metric: forecastSettings.metric,
                        models: selectedModels,  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏
                        test_size: testSize / 100,
                        forecast_periods: forecastSettings.forecast_periods,
                        mapping: mapping
                    })
                });
                
                const result = await response.json();
                
                document.getElementById('trainingStatus').style.display = 'none';
                
                if (result.success) {
                    trainingResults = result.results;
                    displayTrainingResults();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –æ–±—É—á–µ–Ω–∏—è: ' + result.message);
                }
            } catch (error) {
                document.getElementById('trainingStatus').style.display = 'none';
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function displayTrainingResults() {
            document.getElementById('trainingResults').style.display = 'block';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            const tableBody = document.getElementById('modelsComparisonTable');
            const modelSelect = document.getElementById('modelSelect');
            
            tableBody.innerHTML = '';
            modelSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å...</option>';
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ –ø–æ MAPE (–ª—É—á—à–∏–µ –ø–µ—Ä–≤—ã–µ)
            const sortedModels = Object.entries(trainingResults).sort((a, b) => {
                return a[1].metrics.mape - b[1].metrics.mape;
            });
            
            sortedModels.forEach(([modelName, data], index) => {
                const metrics = data.metrics;
                const rank = index + 1;
                const rankBadge = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è MAPE
                let mapeClass = 'metric-good';
                if (metrics.mape > 20) mapeClass = 'metric-bad';
                else if (metrics.mape > 10) mapeClass = 'metric-medium';
                
                // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ä–µ–∑–∞—Ö
                let sliceInfo = '';
                if (data.slices_count) {
                    const rangeText = data.metrics_range 
                        ? `(${data.metrics_range.mape_min.toFixed(1)}%-${data.metrics_range.mape_max.toFixed(1)}%)`
                        : '';
                    sliceInfo = `<br><small class="text-muted">–£—Å—Ä–µ–¥–Ω–µ–Ω–æ –ø–æ ${data.slices_count} —Å—Ä–µ–∑–∞–º ${rangeText}</small>`;
                }
                
                const row = `
                    <tr>
                        <td><strong>${getModelDisplayName(modelName)}</strong>${sliceInfo}</td>
                        <td>${metrics.mae.toLocaleString('ru-RU', {maximumFractionDigits: 2})}</td>
                        <td>${metrics.rmse.toLocaleString('ru-RU', {maximumFractionDigits: 2})}</td>
                        <td><span class="metric-badge ${mapeClass}">${metrics.mape.toFixed(2)}%</span></td>
                        <td><span class="fs-4">${rankBadge}</span></td>
                    </tr>
                `;
                
                tableBody.innerHTML += row;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ select
                const option = document.createElement('option');
                option.value = modelName;
                option.text = `${getModelDisplayName(modelName)} (MAPE: ${metrics.mape.toFixed(2)}%)`;
                if (index === 0) {
                    option.selected = true;
                }
                modelSelect.appendChild(option);
            });
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏
            if (sortedModels.length > 0) {
                updateValidationChart();
            }
        }

        function getModelDisplayName(modelName) {
            const names = {
                'arima': 'ARIMA',
                'prophet': 'Prophet',
                'random_forest': 'Random Forest',
                'random_forest_hierarchy': 'Random Forest Hierarchy',
                'linear_regression': 'Linear Regression',
                'xgboost': 'XGBoost'
            };
            return names[modelName] || modelName;
        }

        function updateValidationChart() {
            const select = document.getElementById('modelSelect');
            const selectedModel = select.value;
            
            if (!selectedModel || !trainingResults[selectedModel]) {
                return;
            }
            
            const modelData = trainingResults[selectedModel];
            const canvas = document.getElementById('validationChart');
            
            if (validationChartInstance) {
                validationChartInstance.destroy();
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
            if (!modelData.validation_data || !modelData.validation_data.periods || modelData.validation_data.periods.length === 0) {
                console.warn('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('–î–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –û–±—É—á–∏—Ç–µ –º–æ–¥–µ–ª–∏ –∑–∞–Ω–æ–≤–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞.', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const ctx = canvas.getContext('2d');
            validationChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: modelData.validation_data.periods,
                    datasets: [
                        {
                            label: '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è',
                            data: modelData.validation_data.actual,
                            borderColor: '#2196F3',
                            backgroundColor: '#2196F333',
                            borderWidth: 4,
                            pointRadius: 6,
                            tension: 0.2,
                            fill: false
                        },
                        {
                            label: '–ü—Ä–æ–≥–Ω–æ–∑ –º–æ–¥–µ–ª–∏',
                            data: modelData.validation_data.predicted,
                            borderColor: '#4CAF50',
                            backgroundColor: '#4CAF5033',
                            borderWidth: 4,
                            borderDash: [5, 5],
                            pointRadius: 6,
                            pointStyle: 'rect',
                            tension: 0.2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 2,
                    plugins: {
                        title: {
                            display: true,
                            text: `${getModelDisplayName(selectedModel)} - –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –≤—ã–±–æ—Ä–∫–µ`,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    if (value === null) return null;
                                    return `${label}: ${value.toLocaleString('ru-RU', {maximumFractionDigits: 2})}`;
                                },
                                footer: function(tooltipItems) {
                                    if (tooltipItems.length >= 2) {
                                        const actual = tooltipItems[0].parsed.y;
                                        const predicted = tooltipItems[1].parsed.y;
                                        const error = Math.abs(actual - predicted);
                                        const errorPercent = (error / actual * 100).toFixed(2);
                                        return `–û—à–∏–±–∫–∞: ${error.toLocaleString('ru-RU', {maximumFractionDigits: 2})} (${errorPercent}%)`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '–ü–µ—Ä–∏–æ–¥ (–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: forecastSettings.metric
                            },
                            beginAtZero: false
                        }
                    }
                }
            });
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
            displayModelMetrics(selectedModel);
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
            renderDetailedValidationTable(selectedModel, modelData);
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è BI-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        let validationPivotMode = 'time-series';
        let validationSelectedMetrics = [];
        let validationSelectedSlices = [];
        let validationSplitField = null;
        
        function switchValidationPivotMode(mode) {
            validationPivotMode = mode;
            
            const titleElement = document.getElementById('validationPivotModeTitle');
            const iconElement = titleElement ? titleElement.previousElementSibling : null;
            const timeSeriesBtn = document.getElementById('validationTimeSeriesModeBtn');
            const slicesBtn = document.getElementById('validationSlicesModeBtn');
            
            if (mode === 'time-series') {
                if (titleElement) titleElement.textContent = '–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã';
                if (iconElement) iconElement.className = 'fas fa-clock me-2';
                if (timeSeriesBtn) {
                    timeSeriesBtn.classList.add('active');
                    slicesBtn.classList.remove('active');
                }
                document.getElementById('validationPrimaryFieldLabel').textContent = '–ú–µ—Ç—Ä–∏–∫–∏';
                document.getElementById('validationSplitFieldLabel').textContent = '–†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Å—Ä–µ–∑–∞–º';
            } else {
                if (titleElement) titleElement.textContent = '–°—Ä–µ–∑—ã';
                if (iconElement) iconElement.className = 'fas fa-layer-group me-2';
                if (slicesBtn) {
                    slicesBtn.classList.add('active');
                    timeSeriesBtn.classList.remove('active');
                }
                document.getElementById('validationPrimaryFieldLabel').textContent = '–ú–µ—Ç—Ä–∏–∫–∏';  // –û—Å—Ç–∞—é—Ç—Å—è –º–µ—Ç—Ä–∏–∫–∏!
                document.getElementById('validationSplitFieldLabel').textContent = '–†–∞–∑–±–∏–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º —Ä—è–¥–∞–º';
            }
            
            populateValidationSelects();
        }
        
        function populateValidationSelects() {
            const modelSelect = document.getElementById('modelSelect');
            const selectedModel = modelSelect ? modelSelect.value : 'random_forest';
            const modelData = trainingResults[selectedModel];
            
            if (!modelData || !modelData.detailed_validation) {
                return;
            }
            
            const detailedData = modelData.detailed_validation;
            const sliceCols = modelData.slice_cols || [];
            
            const primaryCheckboxes = document.getElementById('validationPrimaryFieldCheckboxes');
            const splitRadios = document.getElementById('validationSplitFieldRadioButtons');
            
            if (!primaryCheckboxes || !splitRadios) return;
            
            if (validationPivotMode === 'time-series') {
                const metricName = forecastSettings.metric;
                
                // –†–µ–∂–∏–º "–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã": –ø–µ—Ä–≤–∏—á–Ω–æ–µ –ø–æ–ª–µ = –º–µ—Ç—Ä–∏–∫–∏ (–§–∞–∫—Ç, –ü—Ä–æ–≥–Ω–æ–∑)
                primaryCheckboxes.innerHTML = `
                    <li class="dropdown-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${metricName}_fact" id="validation_metric_fact" checked onchange="updateValidationSelectedMetrics()">
                            <label class="form-check-label" for="validation_metric_fact">${metricName} (–§–∞–∫—Ç)</label>
                        </div>
                    </li>
                    <li class="dropdown-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${metricName}_predicted" id="validation_metric_predicted" checked onchange="updateValidationSelectedMetrics()">
                            <label class="form-check-label" for="validation_metric_predicted">${metricName} (–ü—Ä–æ–≥–Ω–æ–∑)</label>
                        </div>
                    </li>
                `;
                
                // –†–∞–∑–±–∏–≤–∫–∞ = —Å—Ä–µ–∑—ã
                let splitHTML = '';
                sliceCols.forEach(slice => {
                    splitHTML += `
                        <li class="dropdown-item">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="validationSplitFieldSelection" value="${slice}" id="validation_split_${slice}" onchange="updateValidationSelectedSplitField()">
                                <label class="form-check-label" for="validation_split_${slice}">${slice}</label>
                            </div>
                        </li>
                    `;
                });
                splitRadios.innerHTML = splitHTML;
                
                validationSelectedMetrics = [`${metricName}_fact`, `${metricName}_predicted`];
            } else {
                const metricName = forecastSettings.metric;
                
                // –†–µ–∂–∏–º "–°—Ä–µ–∑—ã": –ø–µ—Ä–≤–∏—á–Ω–æ–µ –ø–æ–ª–µ = –º–µ—Ç—Ä–∏–∫–∏ (–æ—Å—Ç–∞—é—Ç—Å—è!), —Ä–∞–∑–±–∏–≤–∫–∞ = –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã
                primaryCheckboxes.innerHTML = `
                    <li class="dropdown-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${metricName}_fact" id="validation_metric_fact_slices" checked onchange="updateValidationSelectedMetrics()">
                            <label class="form-check-label" for="validation_metric_fact_slices">${metricName} (–§–∞–∫—Ç)</label>
                        </div>
                    </li>
                    <li class="dropdown-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${metricName}_predicted" id="validation_metric_predicted_slices" checked onchange="updateValidationSelectedMetrics()">
                            <label class="form-check-label" for="validation_metric_predicted_slices">${metricName} (–ü—Ä–æ–≥–Ω–æ–∑)</label>
                        </div>
                    </li>
                `;
                
                // –†–∞–∑–±–∏–≤–∫–∞ = –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã (year, halfyear, quarter, month)
                const timeFields = [
                    { value: 'year', label: '–ì–æ–¥' },
                    { value: 'Halfyear', label: '–ü–æ–ª—É–≥–æ–¥–∏–µ' },
                    { value: 'Quarter', label: '–ö–≤–∞—Ä—Ç–∞–ª' },
                    { value: 'month', label: '–ú–µ—Å—è—Ü' }
                ];
                
                let splitHTML = '';
                timeFields.forEach(field => {
                    splitHTML += `
                        <li class="dropdown-item">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="validationSplitFieldSelection" value="${field.value}" id="validation_split_${field.value}" onchange="updateValidationSelectedSplitField()">
                                <label class="form-check-label" for="validation_split_${field.value}">${field.label}</label>
                            </div>
                        </li>
                    `;
                });
                splitRadios.innerHTML = splitHTML;
                
                validationSelectedMetrics = [`${metricName}_fact`, `${metricName}_predicted`];
            }
            
            updateValidationDropdownText();
        }
        
        function updateValidationSelectedMetrics() {
            validationSelectedMetrics = [];
            document.querySelectorAll('#validationPrimaryFieldCheckboxes input[type="checkbox"]:checked').forEach(cb => {
                validationSelectedMetrics.push(cb.value);
            });
            updateValidationDropdownText();
        }
        
        
        function updateValidationSelectedSplitField() {
            const selected = document.querySelector('input[name="validationSplitFieldSelection"]:checked');
            validationSplitField = selected ? selected.value : null;
            updateValidationDropdownText();
        }
        
        function updateValidationDropdownText() {
            const primaryText = document.getElementById('validationPrimaryFieldDropdownText');
            const splitText = document.getElementById('validationSplitFieldDropdownText');
            
            // –í –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–∞—Ö –ø–µ—Ä–≤–∏—á–Ω–æ–µ –ø–æ–ª–µ = –º–µ—Ç—Ä–∏–∫–∏
            const count = validationSelectedMetrics.length;
            primaryText.textContent = count > 0 ? `–í—ã–±—Ä–∞–Ω–æ –º–µ—Ç—Ä–∏–∫: ${count}` : '–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç—Ä–∏–∫–∏';
            
            if (validationPivotMode === 'time-series') {
                if (validationSplitField) {
                    splitText.textContent = validationSplitField;
                } else {
                    splitText.textContent = '–¢–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã';
                }
            } else {
                // –†–µ–∂–∏–º "–°—Ä–µ–∑—ã": —Ä–∞–∑–±–∏–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º —Ä—è–¥–∞–º
                if (validationSplitField) {
                    const labels = {
                        'year': '–ì–æ–¥',
                        'Halfyear': '–ü–æ–ª—É–≥–æ–¥–∏–µ',
                        'Quarter': '–ö–≤–∞—Ä—Ç–∞–ª',
                        'month': '–ú–µ—Å—è—Ü'
                    };
                    splitText.textContent = labels[validationSplitField] || validationSplitField;
                } else {
                    splitText.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ä—è–¥';
                }
            }
        }
        
        function toggleAllValidationPrimaryFields(checkbox) {
            const checkboxes = document.querySelectorAll('#validationPrimaryFieldCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateValidationSelectedMetrics();
        }
        
        function resetValidationFilters() {
            // TODO: Implement filter reset
            loadValidationData();
        }
        
        function loadValidationData() {
            const modelSelect = document.getElementById('modelSelect');
            const selectedModel = modelSelect ? modelSelect.value : 'random_forest';
            const modelData = trainingResults[selectedModel];
            
            if (!modelData || !modelData.detailed_validation) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                return;
            }
            
            const detailedData = modelData.detailed_validation;
            const sliceCols = modelData.slice_cols || [];
            const metricName = forecastSettings.metric;
            
            const mappingData = sessionStorage.getItem('dataMapping');
            let mapping = mappingData ? JSON.parse(mappingData) : null;
            
            if (!mapping) {
                alert('–û—à–∏–±–∫–∞: –º–∞–ø–ø–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
            const validationMapping = JSON.parse(JSON.stringify(mapping)); // deep copy
            
            console.log('üìä –ò—Å—Ö–æ–¥–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥:', mapping);
            console.log('üìä –î–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞):', detailedData[0]);
            
            // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–µ—Ç—Ä–∏–∫–∏, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
            validationMapping.columns = validationMapping.columns.filter(col => {
                // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Ä–µ–∑—ã –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—è
                return (col.role === 'dimension') || (col.time_series && col.time_series !== '');
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–≤–µ –º–µ—Ç—Ä–∏–∫–∏: —Ñ–∞–∫—Ç –∏ –ø—Ä–æ–≥–Ω–æ–∑
            validationMapping.columns.push({
                name: `${metricName}_fact`,
                role: 'metric',
                include: validationSelectedMetrics.includes(`${metricName}_fact`)
            });
            
            validationMapping.columns.push({
                name: `${metricName}_predicted`,
                role: 'metric',
                include: validationSelectedMetrics.includes(`${metricName}_predicted`)
            });
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º selectedMetrics
            validationMapping.selectedMetrics = validationSelectedMetrics.filter(m => 
                validationMapping.columns.find(col => col.name === m && col.role === 'metric')
            );
            
            console.log('üìä –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏:', validationMapping);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º: –µ—Å–ª–∏ –µ—Å—Ç—å —Ä–∞–∑–±–∏–≤–∫–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º split-columns
            let renderMode = validationPivotMode;
            let originalMode = validationPivotMode;
            
            if (validationSplitField && validationSplitField !== '') {
                renderMode = 'split-columns';
                console.log('üîÑ –í—ã–±—Ä–∞–Ω–∞ —Ä–∞–∑–±–∏–≤–∫–∞ - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –Ω–∞ split-columns');
            }
            
            console.log('üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞:');
            console.log('   - renderMode:', renderMode);
            console.log('   - originalMode:', originalMode);
            console.log('   - splitBySlice:', validationSplitField || '(–Ω–µ—Ç —Ä–∞–∑–±–∏–≤–∫–∏)');
            console.log('   - selectedMetrics:', validationSelectedMetrics);
            console.log('   - –¥–∞–Ω–Ω—ã—Ö:', detailedData.length);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º renderNewPivotTable
            const container = document.getElementById('timeSeriesChartContainer');
            if (!container) {
                alert('–û—à–∏–±–∫–∞: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            container.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>';
            
            setTimeout(() => {
                try {
                    if (typeof renderNewPivotTable === 'function') {
                        // –ü–µ—Ä–µ–¥–∞–µ–º 5 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: data, mapping, mode, splitBySlice, originalMode
                        const result = renderNewPivotTable(detailedData, validationMapping, renderMode, validationSplitField || '', originalMode);
                        console.log('‚úÖ –¢–∞–±–ª–∏—Ü–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω–∞, —Ä–µ–∑—É–ª—å—Ç–∞—Ç:', result);
                    } else {
                        container.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞: —Ñ—É–Ω–∫—Ü–∏—è renderNewPivotTable –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>';
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                    console.error('Stack trace:', error.stack);
                    container.innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞: ${error.message}</div>`;
                }
            }, 100);
        }
        
        function renderDetailedValidationTable(modelName, modelData) {
            const card = document.getElementById('detailedValidationCard');
            
            if (!modelData.detailed_validation || modelData.detailed_validation.length === 0) {
                console.warn('‚ö†Ô∏è –ù–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤–∞–ª–∏–¥–∞—Ü–∏–∏');
                card.style.display = 'none';
                return;
            }
            
            console.log('üìä –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:', modelData.detailed_validation.length, '—Å—Ç—Ä–æ–∫');
            console.log('üìä –°—Ä–µ–∑—ã:', modelData.slice_cols);
            console.log('üìä –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞:', modelData.detailed_validation[0]);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å BI-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
            card.style.display = 'block';
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ–ª–µ–∫—Ç—ã –∏ –∫–æ–Ω—Ç—Ä–æ–ª—ã
            populateValidationSelects();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–∫–∞–∑–µ
            setTimeout(() => {
                loadValidationData();
            }, 300);
        }

        function displayModelMetrics(modelName) {
            const modelData = trainingResults[modelName];
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥–µ–ª–∏
        }

        async function proceedToForecast() {
            if (!trainingResults) {
                alert('–°–Ω–∞—á–∞–ª–∞ –æ–±—É—á–∏—Ç–µ –º–æ–¥–µ–ª–∏');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å
            const select = document.getElementById('modelSelect');
            const selectedModel = select.value;
            
            if (!selectedModel) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }
            
            if (!confirm(`–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–æ–¥–µ–ª–∏ ${getModelDisplayName(selectedModel)}?`)) {
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å –≤ sessionStorage
            sessionStorage.setItem('selectedForecastModel', selectedModel);
            
            // –°—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–≥–Ω–æ–∑–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —Ç–∞–º —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º
            window.location.href = `/forecast/results?session_id=${currentSessionId}&model=${selectedModel}`;
        }

        function goBack() {
            if (confirm('–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º? –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                window.location.href = `/forecast/settings?session_id=${currentSessionId}`;
            }
        }
    </script>
</body>
</html>

