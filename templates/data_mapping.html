<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARFOR - –ú–∞–ø–ø–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/breadcrumbs.css" rel="stylesheet">
    <script src="/static/breadcrumbs.js"></script>
    <style>
        /* –ú—è—Ç–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ */
        .btn-primary {
            background-color: #81db99 !important;
            border-color: #81db99 !important;
            color: #000 !important;
        }
        
        .btn-primary:hover {
            background-color: #6bc884 !important;
            border-color: #6bc884 !important;
            color: #000 !important;
        }
        
        .btn-primary:focus {
            background-color: #6bc884 !important;
            border-color: #6bc884 !important;
            color: #000 !important;
            box-shadow: 0 0 0 0.2rem rgba(129, 219, 153, 0.25) !important;
        }
        
        .btn-primary:active {
            background-color: #55b96f !important;
            border-color: #55b96f !important;
            color: #000 !important;
        }
        
        .btn-success {
            background-color: #81db99 !important;
            border-color: #81db99 !important;
            color: #000 !important;
        }
        
        .btn-success:hover {
            background-color: #6bc884 !important;
            border-color: #6bc884 !important;
            color: #000 !important;
        }
        
        .btn-info {
            background-color: #81db99 !important;
            border-color: #81db99 !important;
            color: #000 !important;
        }
        
        .btn-info:hover {
            background-color: #6bc884 !important;
            border-color: #6bc884 !important;
            color: #000 !important;
        }
        
        .btn-warning {
            background-color: #81db99 !important;
            border-color: #81db99 !important;
            color: #000 !important;
        }
        
        .btn-warning:hover {
            background-color: #6bc884 !important;
            border-color: #6bc884 !important;
            color: #000 !important;
        }
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 0;
        }
        .mapping-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .column-mapping {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        .column-header {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .data-type-badge {
            font-size: 0.8em;
            padding: 2px 8px;
        }
        .preview-table {
            max-height: 400px;
            overflow-y: auto;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <img src="/static/images/logo.png" alt="MARFOR Logo" height="32" class="me-2" style="object-fit: contain;">
                MARFOR
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-database me-2"></i>–ú–∞–ø–ø–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö
                </span>
            </div>
        </div>
    </nav>

    <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
    <div id="breadcrumbContainer"></div>

    <div class="container mt-4">
        <div class="text-center mb-4">
            <h5>–®–∞–≥ 2: –ú–∞–ø–ø–∏–Ω–≥ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h5>
            <p class="text-muted">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π</p>
        </div>
    </div>

    <div class="container">
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 id="totalRows">0</h3>
                    <p>–°—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 id="totalColumns">0</h3>
                    <p>–ö–æ–ª–æ–Ω–æ–∫</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 id="numericColumns">0</h3>
                    <p>–ß–∏—Å–ª–æ–≤—ã—Ö</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 id="textColumns">0</h3>
                    <p>–¢–µ–∫—Å—Ç–æ–≤—ã—Ö</p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- –ú–∞–ø–ø–∏–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫ -->
            <div class="col-md-8">
                <div class="mapping-card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs me-2"></i>–ú–∞–ø–ø–∏–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫</h5>
                    </div>
                    <div class="card-body">
                        <div id="columnMappings">
                            <!-- –ö–æ–ª–æ–Ω–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                        

                    </div>
                </div>
            </div>

            <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö -->
            <div class="col-md-4">
                <div class="mapping-card">
                    <div class="card-header">
                        <h5><i class="fas fa-eye me-2"></i>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö</h5>
                    </div>
                    <div class="card-body">
                        <div class="preview-table">
                            <table class="table table-sm table-striped">
                                <thead id="previewHeader">
                                    <!-- –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </thead>
                                <tbody id="previewBody">
                                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="mapping-card">
                    <div class="card-header">
                        <h5><i class="fas fa-tools me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6>–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="missingValues" id="removeRows" value="remove">
                                    <label class="form-check-label" for="removeRows">
                                        –£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ —Å –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="missingValues" id="fillZeros" value="zeros" checked>
                                    <label class="form-check-label" for="fillZeros">
                                        –ó–∞–º–µ–Ω–∏—Ç—å –Ω—É–ª—è–º–∏ (—á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="missingValues" id="fillMean" value="mean">
                                    <label class="form-check-label" for="fillMean">
                                        –ó–∞–º–µ–Ω–∏—Ç—å —Å—Ä–µ–¥–Ω–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6>–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±—Ä–æ—Å–æ–≤</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="detectOutliers">
                                    <label class="form-check-label" for="detectOutliers">
                                        –û–±–Ω–∞—Ä—É–∂–∏—Ç—å –≤—ã–±—Ä–æ—Å—ã
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="removeOutliers">
                                    <label class="form-check-label" for="removeOutliers">
                                        –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–æ—Å—ã
                                    </label>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">–ü–æ—Ä–æ–≥ –≤—ã–±—Ä–æ—Å–æ–≤ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π)</label>
                                    <input type="number" class="form-control" id="outlierThreshold" value="3" min="1" max="5" step="0.1">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6>–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="normalizeData">
                                    <label class="form-check-label" for="normalizeData">
                                        –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å —á–∏—Å–ª–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="logTransform">
                                    <label class="form-check-label" for="logTransform">
                                        –õ–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="createFeatures">
                                    <label class="form-check-label" for="createFeatures">
                                        –°–æ–∑–¥–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <button class="btn btn-secondary me-3" onclick="goBack()">
                    <i class="fas fa-arrow-left me-2"></i>–ù–∞–∑–∞–¥
                </button>
                <button class="btn btn-info me-3" onclick="document.getElementById('updateFileInput').click()" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π CSV —Ñ–∞–π–ª —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–∞–ø–ø–∏–Ω–≥–∞">
                    <i class="fas fa-upload me-2"></i>–û–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª
                </button>
                <input type="file" id="updateFileInput" accept=".csv" style="display: none;" onchange="updateDataFile(event)">
                <button class="btn btn-primary me-3" onclick="previewData()">
                    <i class="fas fa-eye me-2"></i>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                </button>
                <button class="btn btn-warning me-2" onclick="saveMappingDraft()">
                    <i class="fas fa-save me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫
                </button>
                <button class="btn btn-success" onclick="applyMapping()">
                    <i class="fas fa-check me-2"></i>–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let dataInfo = null;
        let currentSessionId = null;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ sessionStorage
        window.onload = function() {
            const savedData = sessionStorage.getItem('uploadedData');
            if (savedData) {
                dataInfo = JSON.parse(savedData);
                currentSessionId = sessionStorage.getItem('sessionId');
                initializeMapping();
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É
                window.location.href = '/forecast';
            }
        };

        function initializeMapping() {
            updateStats();
            createColumnMappings();
            createDataPreview();
        }

        function updateStats() {
            document.getElementById('totalRows').textContent = dataInfo.shape[0].toLocaleString();
            document.getElementById('totalColumns').textContent = dataInfo.shape[1];
            
            let numericCount = 0;
            let textCount = 0;
            
            dataInfo.columns.forEach((col, index) => {
                const dtype = dataInfo.dtypes[col];
                if (dtype.includes('int') || dtype.includes('float')) {
                    numericCount++;
                } else {
                    textCount++;
                }
            });
            
            document.getElementById('numericColumns').textContent = numericCount;
            document.getElementById('textColumns').textContent = textCount;
        }

        function createColumnMappings() {
            const container = document.getElementById('columnMappings');
            container.innerHTML = '';

            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
            const headerDiv = document.createElement('div');
            headerDiv.className = 'column-mapping';
            headerDiv.innerHTML = `
                <div class="column-header">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <strong>–ö–æ–ª–æ–Ω–∫–∞</strong>
                            </div>
                            <div class="col-md-1">
                                <strong>–ü—É—Å—Ç—ã–µ</strong>
                            </div>
                            <div class="col-md-2">
                                <strong>–†–æ–ª—å</strong>
                            </div>
                            <div class="col-md-2">
                                <strong>–í—Ä–µ–º–µ–Ω–Ω–æ–π —Ä—è–¥</strong>
                            </div>
                            <div class="col-md-1">
                                <strong>–£—Ä–æ–≤–µ–Ω—å</strong>
                            </div>
                            <div class="col-md-2">
                                <strong>–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö</strong>
                            </div>
                            <div class="col-md-1">
                                <strong>–í–∫–ª—é—á–∏—Ç—å</strong>
                            </div>
                        </div>
                </div>
            `;
            container.appendChild(headerDiv);

            dataInfo.columns.forEach((col, index) => {
                const dtype = dataInfo.dtypes[col];
                const missingCount = dataInfo.missing_values[col];
                const missingPercent = ((missingCount / dataInfo.shape[0]) * 100).toFixed(1);

                const columnDiv = document.createElement('div');
                columnDiv.className = 'column-mapping';
                columnDiv.innerHTML = `
                    <div class="column-header">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <strong>${col}</strong>
                                <span class="badge ${getDataTypeBadgeClass(dtype)} data-type-badge ms-2">
                                    ${getDataTypeName(dtype)}
                                </span>
                            </div>
                            <div class="col-md-1">
                                <small class="text-muted">${missingCount} (${missingPercent}%)</small>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="role_${index}" onchange="updateColumnRole(${index}, this.value)">
                                    <option value="auto" ${dtype.includes('int') || dtype.includes('float') ? 'selected' : ''}>–ê–≤—Ç–æ</option>
                                    <option value="metric" ${dtype.includes('int') || dtype.includes('float') ? 'selected' : ''}>Metric</option>
                                    <option value="dimension" ${!dtype.includes('int') && !dtype.includes('float') ? 'selected' : ''}>Dimension</option>
                                    <option value="skip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="time_series_${index}" onchange="updateTimeSeries(${index}, this.value)">
                                    <option value="">–ù–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ä—è–¥</option>
                                    <option value="date">–î–∞—Ç–∞</option>
                                    <option value="year">–ì–æ–¥</option>
                                    <option value="month">–ú–µ—Å—è—Ü</option>
                                    <option value="week">–ù–µ–¥–µ–ª—è</option>
                                    <option value="quarter">–ö–≤–∞—Ä—Ç–∞–ª</option>
                                    <option value="halfyear">–ü–æ–ª—É–≥–æ–¥–∏–µ</option>
                                </select>
                            </div>
                            <div class="col-md-1">
                                <select class="form-select form-select-sm" id="nesting_level_${index}" onchange="updateNestingLevel(${index}, this.value)">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="type_${index}" onchange="updateColumnType(${index}, this.value)">
                                    <option value="auto" ${dtype.includes('int') || dtype.includes('float') ? 'selected' : ''}>–ê–≤—Ç–æ</option>
                                    <option value="numeric">–ß–∏—Å–ª–æ–≤–æ–π</option>
                                    <option value="text">–¢–µ–∫—Å—Ç–æ–≤—ã–π</option>
                                    <option value="date">–î–∞—Ç–∞</option>
                                    <option value="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</option>
                                </select>
                            </div>
                            <div class="col-md-1">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="include_${index}" checked>
                                    <label class="form-check-label" for="include_${index}">
                                        –í–∫–ª—é—á–∏—Ç—å
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(columnDiv);
            });
        }


        function createDataPreview() {
            const header = document.getElementById('previewHeader');
            const body = document.getElementById('previewBody');
            
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏
            header.innerHTML = '';
            dataInfo.columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                header.appendChild(th);
            });
            
            // –î–∞–Ω–Ω—ã–µ (–ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫)
            body.innerHTML = '';
            dataInfo.sample_data.forEach(row => {
                const tr = document.createElement('tr');
                dataInfo.columns.forEach(col => {
                    const td = document.createElement('td');
                    td.textContent = row[col] || '';
                    td.style.fontSize = '0.8em';
                    tr.appendChild(td);
                });
                body.appendChild(tr);
            });
        }

        function getDataTypeName(dtype) {
            if (dtype.includes('int')) return '–¶–µ–ª–æ–µ';
            if (dtype.includes('float')) return '–î—Ä–æ–±–Ω–æ–µ';
            if (dtype.includes('object')) return '–¢–µ–∫—Å—Ç';
            return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        }

        function getDataTypeBadgeClass(dtype) {
            if (dtype.includes('int') || dtype.includes('float')) return 'bg-primary';
            if (dtype.includes('object')) return 'bg-info';
            return 'bg-secondary';
        }

        function updateColumnType(index, type) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∏–ø –∫–æ–ª–æ–Ω–∫–∏
            console.log(`–ö–æ–ª–æ–Ω–∫–∞ ${index} –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ —Ç–∏–ø: ${type}`);
        }

        function updateColumnRole(index, role) {
            console.log(`Column ${index} role updated to: ${role}`);
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
            const typeSelect = document.getElementById(`type_${index}`);
            if (typeSelect) {
                if (role === 'metric') {
                    typeSelect.value = 'numeric';
                } else if (role === 'dimension') {
                    typeSelect.value = 'text';
                }
            }
        }

        function updateTimeSeries(index, timeSeriesType) {
            console.log(`Column ${index} time series updated to: ${timeSeriesType}`);
            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ä—è–¥, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–æ–ª—å –∫–∞–∫ dimension
            if (timeSeriesType && timeSeriesType !== '') {
                const roleSelect = document.getElementById(`role_${index}`);
                if (roleSelect) {
                    roleSelect.value = 'dimension';
                }
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤
                const nestingSelect = document.getElementById(`nesting_level_${index}`);
                if (nestingSelect) {
                    const defaultLevels = {
                        'year': '1',
                        'halfyear': '2', 
                        'quarter': '3',
                        'month': '4',
                        'week': '5',
                        'date': '6'
                    };
                    nestingSelect.value = defaultLevels[timeSeriesType] || '0';
                }
            }
        }

        function updateNestingLevel(index, level) {
            console.log(`Column ${index} nesting level updated to: ${level}`);
        }

        function previewData() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            alert('–§—É–Ω–∫—Ü–∏—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞');
        }

        async function updateDataFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm(`–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª "${file.name}"?\n–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–ø–ø–∏–Ω–≥–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –∏ –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫ –Ω–æ–≤—ã–º –¥–∞–Ω–Ω—ã–º.`)) {
                event.target.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞
                return;
            }

            try {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–ø–ø–∏–Ω–≥–∞
                const currentMapping = collectMappingData();
                console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–ø–ø–∏–Ω–≥–∞:', currentMapping);

                // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
                const formData = new FormData();
                formData.append('file', file);
                formData.append('session_id', sessionStorage.getItem('currentSessionId'));

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª
                const response = await fetch('/api/update_file', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!\n\n–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${result.rows} —Å—Ç—Ä–æ–∫, ${result.columns} –∫–æ–ª–æ–Ω–æ–∫\n–§–∞–π–ª: ${result.filename}`);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º session_id –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
                    if (result.session_id) {
                        sessionStorage.setItem('currentSessionId', result.session_id);
                    }
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –º–∞–ø–ø–∏–Ω–≥–∞
                    location.reload();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + result.message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + error.message);
            } finally {
                event.target.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞ —Å–Ω–æ–≤–∞
            }
        }

        function applyMapping() {
            // –°–æ–±–∏—Ä–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–ø–ø–∏–Ω–≥–∞
            const mapping = collectMappingData();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞–ø–ø–∏–Ω–≥–∞...';
            button.disabled = true;

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–∞–ø–ø–∏–Ω–≥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            fetch('/api/apply_mapping', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_id: currentSessionId,
                    mapping: mapping
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    sessionStorage.setItem('processedData', JSON.stringify(data.processed_data_info));
                    sessionStorage.setItem('dataMapping', JSON.stringify(mapping));
                    
                    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
                    autoSaveProject(mapping, data.processed_data_info);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                    showSuccessMessage('–ú–∞–ø–ø–∏–Ω–≥ –ø—Ä–∏–º–µ–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    
                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        window.location.href = '/forecast';
                    }, 2000);
                } else {
                    showErrorMessage(data.message);
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            })
            .catch(error => {
                showErrorMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∞–ø–ø–∏–Ω–≥–∞: ' + error.message);
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }

        function showSuccessMessage(message) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(alert, document.querySelector('.container').firstChild);
        }

        function showErrorMessage(message) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(alert, document.querySelector('.container').firstChild);
        }

        function goBack() {
            window.location.href = '/forecast';
        }
        
        async function autoSaveProject(mapping, processedData) {
            try {
                const projectId = sessionStorage.getItem('currentProjectId');
                if (!projectId) {
                    console.log('‚ÑπÔ∏è –ü—Ä–æ–µ–∫—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω (–Ω–µ—Ç project_id)');
                    return;
                }
                
                console.log('üíæ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞...');
                
                const response = await fetch('/api/save_project', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: sessionStorage.getItem('projectName') || '–ü—Ä–æ–µ–∫—Ç –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                        session_id: currentSessionId,
                        data_mapping: mapping,
                        processed_data: processedData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ –ü—Ä–æ–µ–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
                    // –û–±–Ω–æ–≤–ª—è–µ–º ID –ø—Ä–æ–µ–∫—Ç–∞ –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
                    if (result.project_id) {
                        sessionStorage.setItem('currentProjectId', result.project_id);
                    }
                } else {
                    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', result.message);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
            }
        }

        function collectMappingData() {
            // –°–æ–±–∏—Ä–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–ø–ø–∏–Ω–≥–∞
            const mapping = {
                columns: [],
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                missingValues: document.querySelector('input[name="missingValues"]:checked')?.value || 'zeros',
                detectOutliers: document.getElementById('detectOutliers')?.checked || false,
                removeOutliers: document.getElementById('removeOutliers')?.checked || false,
                outlierThreshold: parseFloat(document.getElementById('outlierThreshold')?.value) || 3,
                normalizeData: document.getElementById('normalizeData')?.checked || false,
                logTransform: document.getElementById('logTransform')?.checked || false,
                createFeatures: document.getElementById('createFeatures')?.checked || false
            };

            // –°–æ–±–∏—Ä–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–ª–æ–Ω–æ–∫
            if (dataInfo && dataInfo.columns) {
                dataInfo.columns.forEach((col, index) => {
                    const checkbox = document.getElementById(`include_${index}`);
                    const typeSelect = document.getElementById(`type_${index}`);
                    const roleSelect = document.getElementById(`role_${index}`);
                    const timeSeriesSelect = document.getElementById(`time_series_${index}`);
                    const nestingSelect = document.getElementById(`nesting_level_${index}`);
                    
                    mapping.columns.push({
                        name: col,
                        index: index,
                        type: typeSelect?.value || 'auto',
                        role: roleSelect?.value || 'auto',
                        time_series: timeSeriesSelect?.value || '',
                        nesting_level: parseInt(nestingSelect?.value) || 0,
                        include: checkbox?.checked !== false // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true
                    });
                });
            }

            return mapping;
        }

        function saveMappingDraft() {
            const mapping = collectMappingData();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫ –≤ localStorage
            localStorage.setItem('mappingDraft', JSON.stringify(mapping));
            
            alert('–ß–µ—Ä–Ω–æ–≤–∏–∫ –º–∞–ø–ø–∏–Ω–≥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
        }

        function loadMappingDraft() {
            const draft = localStorage.getItem('mappingDraft');
            if (draft) {
                try {
                    const mapping = JSON.parse(draft);
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    if (mapping.columns) {
                        mapping.columns.forEach((col, index) => {
                            const checkbox = document.getElementById(`include_${index}`);
                            if (checkbox) {
                                checkbox.checked = col.include;
                            }
                            
                            const typeSelect = document.getElementById(`type_${index}`);
                            if (typeSelect) {
                                typeSelect.value = col.type || 'auto';
                            }
                            
                            const roleSelect = document.getElementById(`role_${index}`);
                            if (roleSelect) {
                                roleSelect.value = col.role || 'auto';
                            }
                            
                            const timeSeriesSelect = document.getElementById(`time_series_${index}`);
                            if (timeSeriesSelect) {
                                timeSeriesSelect.value = col.time_series || '';
                            }
                            
                            const nestingSelect = document.getElementById(`nesting_level_${index}`);
                            if (nestingSelect) {
                                nestingSelect.value = col.nesting_level || '0';
                            }
                        });
                    }
                    
                    
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
                    if (mapping.missingValues) {
                        const radioButton = document.querySelector(`input[name="missingValues"][value="${mapping.missingValues}"]`);
                        if (radioButton) {
                            radioButton.checked = true;
                        }
                    }
                    
                    const detectOutliersEl = document.getElementById('detectOutliers');
                    if (detectOutliersEl && mapping.detectOutliers !== undefined) {
                        detectOutliersEl.checked = mapping.detectOutliers;
                    }
                    
                    const removeOutliersEl = document.getElementById('removeOutliers');
                    if (removeOutliersEl && mapping.removeOutliers !== undefined) {
                        removeOutliersEl.checked = mapping.removeOutliers;
                    }
                    
                    const outlierThresholdEl = document.getElementById('outlierThreshold');
                    if (outlierThresholdEl && mapping.outlierThreshold !== undefined) {
                        outlierThresholdEl.value = mapping.outlierThreshold;
                    }
                    
                    const normalizeDataEl = document.getElementById('normalizeData');
                    if (normalizeDataEl && mapping.normalizeData !== undefined) {
                        normalizeDataEl.checked = mapping.normalizeData;
                    }
                    
                    const logTransformEl = document.getElementById('logTransform');
                    if (logTransformEl && mapping.logTransform !== undefined) {
                        logTransformEl.checked = mapping.logTransform;
                    }
                    
                    const createFeaturesEl = document.getElementById('createFeatures');
                    if (createFeaturesEl && mapping.createFeatures !== undefined) {
                        createFeaturesEl.checked = mapping.createFeatures;
                    }
                    
                    console.log('–ß–µ—Ä–Ω–æ–≤–∏–∫ –º–∞–ø–ø–∏–Ω–≥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞:', error);
                }
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –†–µ–Ω–¥–µ—Ä–∏–º —Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏
            if (window.breadcrumbsModule) {
                window.breadcrumbsModule.render(2); // –®–∞–≥ 2 - –ú–∞–ø–ø–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫ –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
            setTimeout(loadMappingDraft, 500);
        });
    </script>
</body>
</html>
