<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARFOR - Настройка прогноза</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .btn-primary {
            background-color: #81db99 !important;
            border-color: #81db99 !important;
            color: #000 !important;
        }
        
        .btn-primary:hover {
            background-color: #6bc884 !important;
        }
        
        .timeline-row {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }
        
        .timeline-row.forecast {
            border-color: #ff9800;
            background: #fff3e0;
        }
        
        .forecast-divider {
            border-top: 3px dashed #ff9800;
            margin: 20px 0;
            position: relative;
        }
        
        .forecast-divider::before {
            content: "Горизонт прогноза";
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0 10px;
            color: #ff9800;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/forecast">
                <img src="/static/images/logo.png" alt="MARFOR Logo" height="32" class="me-2" style="object-fit: contain;">
                <strong>MARFOR</strong>
            </a>
            <span class="navbar-text">
                <i class="fas fa-cog me-2"></i>Настройка прогноза
            </span>
            <div class="ms-auto">
                <span class="badge bg-success" style="font-size: 0.8em;">
                    <i class="fas fa-code"></i> v2.16.1
                </span>
            </div>
        </div>
    </nav>

    <!-- Основной контент -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>Настройка горизонта прогнозирования
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Укажите временной период для прогнозирования. Вы можете добавить новые годы и выбрать детализацию по полугодиям, кварталам и месяцам.
                        </div>

                        <!-- Информация о текущих данных -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-database me-2"></i>Текущие данные</h6>
                            </div>
                            <div class="card-body" id="currentDataInfo">
                                Загрузка...
                            </div>
                        </div>

                        <!-- Временные ряды -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-list me-2"></i>Временные ряды</h6>
                                <button class="btn btn-sm btn-success" onclick="addNewYear()">
                                    <i class="fas fa-plus me-2"></i>Добавить год
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="timelineContainer">
                                    <!-- Здесь будут отображаться временные ряды -->
                                </div>
                            </div>
                        </div>

                        <!-- График с визуализацией горизонта -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Визуализация горизонта прогноза</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="forecastHorizonChart" style="height: 400px; width: 100%;"></canvas>
                            </div>
                        </div>

                        <!-- Кнопки действий -->
                        <div class="text-center mt-4">
                            <button class="btn btn-secondary me-3" onclick="goBack()">
                                <i class="fas fa-arrow-left me-2"></i>Назад
                            </button>
                            <button class="btn btn-success" onclick="saveForecastSettings()">
                                <i class="fas fa-save me-2"></i>Сохранить и продолжить
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentSessionId = null;
        let timeSeriesConfig = null;
        let existingData = [];
        let forecastPeriods = [];
        let chartInstance = null;

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', async function() {
            // Получаем session_id из URL
            const urlParams = new URLSearchParams(window.location.search);
            currentSessionId = urlParams.get('session_id') || sessionStorage.getItem('currentSessionId');
            
            if (!currentSessionId) {
                alert('Сессия не найдена. Вернитесь на главную страницу.');
                window.location.href = '/forecast';
                return;
            }
            
            await loadTimeSeriesData();
        });

        async function loadTimeSeriesData() {
            try {
                // Получаем информацию о данных
                const response = await fetch(`/api/get_processed_data/${currentSessionId}`);
                const result = await response.json();
                
                if (!result.success) {
                    alert('Ошибка загрузки данных: ' + result.message);
                    return;
                }
                
                const dataInfo = result.data_info;
                
                // Получаем маппинг из sessionStorage
                const mappingStr = sessionStorage.getItem('dataMapping');
                const mapping = mappingStr ? JSON.parse(mappingStr) : null;
                
                if (!mapping || !mapping.columns) {
                    alert('Настройки маппинга не найдены. Вернитесь на страницу маппинга.');
                    window.location.href = '/forecast/mapping';
                    return;
                }
                
                // Находим временные поля
                timeSeriesConfig = {
                    year: null,
                    halfyear: null,
                    quarter: null,
                    month: null
                };
                
                mapping.columns.forEach(col => {
                    if (col.time_series && col.include) {
                        timeSeriesConfig[col.time_series] = col.name;
                    }
                });
                
                console.log('Конфигурация временных рядов:', timeSeriesConfig);
                
                // Показываем информацию о текущих данных
                displayCurrentDataInfo(dataInfo, timeSeriesConfig);
                
                // Загружаем существующие временные ряды
                await loadExistingTimeSeries();
                
                // Отображаем временные ряды
                renderTimeline();
                
                // Отрисовываем график
                renderForecastChart();
                
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                alert('Ошибка загрузки данных: ' + error.message);
            }
        }

        function displayCurrentDataInfo(dataInfo, config) {
            const infoDiv = document.getElementById('currentDataInfo');
            const hasYear = config.year ? '✅' : '❌';
            const hasHalfyear = config.halfyear ? '✅' : '❌';
            const hasQuarter = config.quarter ? '✅' : '❌';
            const hasMonth = config.month ? '✅' : '❌';
            
            infoDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Всего записей:</strong> ${dataInfo.shape[0].toLocaleString('ru-RU')}</p>
                        <p><strong>Колонок:</strong> ${dataInfo.shape[1]}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Временные поля:</strong></p>
                        <ul class="list-unstyled ms-3">
                            <li>${hasYear} Год: ${config.year || 'не настроено'}</li>
                            <li>${hasHalfyear} Полугодие: ${config.halfyear || 'не настроено'}</li>
                            <li>${hasQuarter} Квартал: ${config.quarter || 'не настроено'}</li>
                            <li>${hasMonth} Месяц: ${config.month || 'не настроено'}</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        async function loadExistingTimeSeries() {
            try {
                // Запрашиваем уникальные значения временных полей
                const response = await fetch(`/api/get_time_series_values/${currentSessionId}`);
                const result = await response.json();
                
                if (result.success) {
                    existingData = result.time_series;
                    console.log('Существующие временные ряды:', existingData);
                } else {
                    console.error('Ошибка получения временных рядов:', result.message);
                }
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }

        function renderTimeline() {
            const container = document.getElementById('timelineContainer');
            
            if (existingData.length === 0) {
                container.innerHTML = '<p class="text-muted">Нет данных для отображения</p>';
                return;
            }
            
            let html = '<h6 class="mb-3">Существующие данные:</h6>';
            
            // Группируем по годам
            const yearGroups = {};
            existingData.forEach(item => {
                const year = item.year;
                if (!yearGroups[year]) {
                    yearGroups[year] = [];
                }
                yearGroups[year].push(item);
            });
            
            // Отображаем каждый год
            Object.keys(yearGroups).sort().forEach(year => {
                html += `<div class="timeline-row">`;
                html += `<strong>Год: ${year}</strong>`;
                html += `<div class="ms-3 mt-2">`;
                
                const items = yearGroups[year];
                const periods = new Set();
                items.forEach(item => {
                    if (item.halfyear) periods.add(`H${item.halfyear}`);
                    if (item.quarter) periods.add(`Q${item.quarter}`);
                    if (item.month) periods.add(`М${item.month}`);
                });
                
                if (periods.size > 0) {
                    html += `<small class="text-muted">Периоды: ${Array.from(periods).join(', ')}</small>`;
                }
                
                html += `</div>`;
                html += `</div>`;
            });
            
            // Разделитель
            html += '<div class="forecast-divider"></div>';
            
            // Секция для прогнозных периодов
            html += '<h6 class="mb-3 mt-4">Прогнозные периоды:</h6>';
            html += '<div id="forecastPeriodsContainer">';
            
            if (forecastPeriods.length === 0) {
                html += '<p class="text-muted">Нажмите "Добавить год" чтобы создать прогнозный период</p>';
            } else {
                forecastPeriods.forEach((period, index) => {
                    html += renderForecastPeriod(period, index);
                });
            }
            
            html += '</div>';
            
            container.innerHTML = html;
        }

        function renderForecastPeriod(period, index) {
            let html = `<div class="timeline-row forecast" id="forecast-period-${index}">`;
            html += `<div class="d-flex justify-content-between align-items-center mb-2">`;
            html += `<strong>Прогноз: Год ${period.year}</strong>`;
            html += `<button class="btn btn-sm btn-danger" onclick="removeForecastPeriod(${index})">`;
            html += `<i class="fas fa-times"></i></button>`;
            html += `</div>`;
            
            // Выбор детализации
            html += `<div class="row">`;
            
            // Полугодия
            if (timeSeriesConfig.halfyear) {
                html += `<div class="col-md-3">`;
                html += `<label class="form-label">Полугодия:</label>`;
                html += `<div class="form-check">`;
                html += `<input class="form-check-input" type="checkbox" id="h1-${index}" value="H1" ${period.halfyears.includes('H1') ? 'checked' : ''} onchange="updateForecastPeriod(${index})">`;
                html += `<label class="form-check-label" for="h1-${index}">H1</label>`;
                html += `</div>`;
                html += `<div class="form-check">`;
                html += `<input class="form-check-input" type="checkbox" id="h2-${index}" value="H2" ${period.halfyears.includes('H2') ? 'checked' : ''} onchange="updateForecastPeriod(${index})">`;
                html += `<label class="form-check-label" for="h2-${index}">H2</label>`;
                html += `</div>`;
                html += `</div>`;
            }
            
            // Кварталы
            if (timeSeriesConfig.quarter) {
                html += `<div class="col-md-3">`;
                html += `<label class="form-label">Кварталы:</label>`;
                for (let q = 1; q <= 4; q++) {
                    html += `<div class="form-check">`;
                    html += `<input class="form-check-input" type="checkbox" id="q${q}-${index}" value="Q${q}" ${period.quarters.includes(`Q${q}`) ? 'checked' : ''} onchange="updateForecastPeriod(${index})">`;
                    html += `<label class="form-check-label" for="q${q}-${index}">Q${q}</label>`;
                    html += `</div>`;
                }
                html += `</div>`;
            }
            
            // Месяцы
            if (timeSeriesConfig.month) {
                html += `<div class="col-md-6">`;
                html += `<label class="form-label">Месяцы:</label>`;
                html += `<div class="row">`;
                for (let m = 1; m <= 12; m++) {
                    html += `<div class="col-4">`;
                    html += `<div class="form-check">`;
                    html += `<input class="form-check-input" type="checkbox" id="m${m}-${index}" value="${m}" ${period.months.includes(m) ? 'checked' : ''} onchange="updateForecastPeriod(${index})">`;
                    html += `<label class="form-check-label" for="m${m}-${index}">${m}</label>`;
                    html += `</div>`;
                    html += `</div>`;
                }
                html += `</div>`;
                html += `</div>`;
            }
            
            html += `</div>`;
            html += `</div>`;
            
            return html;
        }

        function addNewYear() {
            // Определяем следующий год
            let maxYear = 0;
            
            if (existingData.length > 0) {
                maxYear = Math.max(...existingData.map(d => d.year));
            }
            
            if (forecastPeriods.length > 0) {
                maxYear = Math.max(maxYear, ...forecastPeriods.map(p => p.year));
            }
            
            const newYear = maxYear + 1;
            
            // Добавляем новый прогнозный период
            forecastPeriods.push({
                year: newYear,
                halfyears: [],
                quarters: [],
                months: []
            });
            
            renderTimeline();
            renderForecastChart();
        }

        function removeForecastPeriod(index) {
            if (confirm(`Удалить прогнозный период для ${forecastPeriods[index].year} года?`)) {
                forecastPeriods.splice(index, 1);
                renderTimeline();
                renderForecastChart();
            }
        }

        function updateForecastPeriod(index) {
            const period = forecastPeriods[index];
            
            // Обновляем полугодия
            period.halfyears = [];
            ['H1', 'H2'].forEach(h => {
                const checkbox = document.getElementById(`${h.toLowerCase()}-${index}`);
                if (checkbox && checkbox.checked) {
                    period.halfyears.push(h);
                }
            });
            
            // Обновляем кварталы
            period.quarters = [];
            for (let q = 1; q <= 4; q++) {
                const checkbox = document.getElementById(`q${q}-${index}`);
                if (checkbox && checkbox.checked) {
                    period.quarters.push(`Q${q}`);
                }
            }
            
            // Обновляем месяцы
            period.months = [];
            for (let m = 1; m <= 12; m++) {
                const checkbox = document.getElementById(`m${m}-${index}`);
                if (checkbox && checkbox.checked) {
                    period.months.push(m);
                }
            }
            
            console.log('Обновлен период:', period);
            renderForecastChart();
        }

        function renderForecastChart() {
            const canvas = document.getElementById('forecastHorizonChart');
            if (!canvas) return;
            
            // Уничтожаем предыдущий график
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Подготавливаем данные для графика
            const labels = [];
            const historicalData = [];
            const forecastData = [];
            
            // Добавляем исторические данные (группируем по годам для простоты)
            const yearGroups = {};
            existingData.forEach(item => {
                if (!yearGroups[item.year]) {
                    yearGroups[item.year] = 0;
                }
                yearGroups[item.year]++;
            });
            
            Object.keys(yearGroups).sort().forEach(year => {
                labels.push(year);
                historicalData.push(yearGroups[year]);
                forecastData.push(null);
            });
            
            // Добавляем прогнозные периоды
            forecastPeriods.forEach(period => {
                labels.push(period.year);
                historicalData.push(null);
                
                // Считаем количество периодов
                let count = 0;
                if (period.months.length > 0) count = period.months.length;
                else if (period.quarters.length > 0) count = period.quarters.length * 3;
                else if (period.halfyears.length > 0) count = period.halfyears.length * 6;
                else count = 12; // Весь год
                
                forecastData.push(count);
            });
            
            const ctx = canvas.getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Исторические данные',
                            data: historicalData,
                            borderColor: '#2196F3',
                            backgroundColor: '#2196F333',
                            borderWidth: 3,
                            pointRadius: 6,
                            tension: 0.2
                        },
                        {
                            label: 'Прогноз',
                            data: forecastData,
                            borderColor: '#FF9800',
                            backgroundColor: '#FF980033',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            pointRadius: 6,
                            pointStyle: 'rectRot',
                            tension: 0.2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Горизонт прогнозирования',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    if (value === null) return null;
                                    return `${label}: ${value} периодов`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Год'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Количество периодов'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        async function saveForecastSettings() {
            if (forecastPeriods.length === 0) {
                alert('Добавьте хотя бы один прогнозный период');
                return;
            }
            
            try {
                const settings = {
                    session_id: currentSessionId,
                    forecast_periods: forecastPeriods,
                    time_series_config: timeSeriesConfig
                };
                
                const response = await fetch('/api/save_forecast_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ Настройки прогноза сохранены!');
                    // Переходим к следующему шагу (пока вернемся на главную)
                    window.location.href = '/forecast';
                } else {
                    alert('❌ Ошибка: ' + result.message);
                }
            } catch (error) {
                console.error('Ошибка сохранения:', error);
                alert('❌ Ошибка сохранения: ' + error.message);
            }
        }

        function goBack() {
            window.location.href = '/forecast';
        }
    </script>
</body>
</html>

