<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARFOR - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/breadcrumbs.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/breadcrumbs.js?v=20251018b"></script>
    <style>
        .btn-primary {
            background-color: #81db99 !important;
            border-color: #81db99 !important;
            color: #000 !important;
        }
        
        .btn-primary:hover {
            background-color: #6bc884 !important;
        }
        
        .timeline-container {
            display: flex;
            overflow-x: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            gap: 10px;
        }
        
        .timeline-year {
            display: flex;
            flex-direction: column;
            min-width: 400px;
        }
        
        .year-header {
            font-size: 0.95em;
            font-weight: bold;
            padding: 6px 10px;
            background: #2196f3;
            color: white;
            text-align: center;
            border-radius: 6px 6px 0 0;
            margin-bottom: 5px;
        }
        
        .year-header.forecast {
            background: #ff9800;
        }
        
        .timeline-months {
            display: flex;
            gap: 4px;
            padding: 5px;
            background: white;
            border-radius: 0 0 6px 6px;
        }
        
        .month-cell {
            width: 28px;
            height: 50px;
            border: 1.5px solid #2196f3;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            cursor: default;
            transition: all 0.2s;
            position: relative;
        }
        
        .month-cell.forecast {
            border-color: #ff9800;
            background: #fff3e0;
        }
        
        .month-cell.empty {
            opacity: 0.2;
            border-style: dashed;
        }
        
        .month-number {
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .month-label {
            font-size: 0.55em;
            color: #666;
            margin-top: 2px;
        }
        
        .forecast-controls {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/forecast">
                <img src="/static/images/logo.png" alt="MARFOR Logo" height="32" class="me-2" style="object-fit: contain;">
                <strong>MARFOR</strong>
            </a>
            <span class="navbar-text">
                <i class="fas fa-cog me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞
            </span>
            <div class="ms-auto">
                <span class="badge bg-success" style="font-size: 0.8em;">
                    <i class="fas fa-code"></i> v2.18.0
                </span>
            </div>
        </div>
    </nav>

    <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
    <div id="breadcrumbContainer"></div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <!-- –í—ã–±–æ—Ä –º–µ—Ç—Ä–∏–∫–∏ -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>–í—ã–±–æ—Ä –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <label class="form-label">–ú–µ—Ç—Ä–∏–∫–∞:</label>
                                <select id="metricSelect" class="form-select" onchange="updateMetricChart()">
                                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç—Ä–∏–∫—É, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π –±—É–¥–µ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –ø—Ä–æ–≥–Ω–æ–∑. –ì—Ä–∞—Ñ–∏–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ì—Ä–∞—Ñ–∏–∫ –º–µ—Ç—Ä–∏–∫–∏ -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>–ì—Ä–∞—Ñ–∏–∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–µ—Ç—Ä–∏–∫–∏
                        </h6>
                    </div>
                    <div class="card-body">
                        <canvas id="metricChart" style="height: 400px; width: 100%;"></canvas>
                    </div>
                </div>

                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞ -->
                <div class="card mb-3">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-calendar-plus me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="forecast-controls">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">–ì–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ (–º–µ—Å—è—Ü—ã):</label>
                                    <input type="number" id="forecastMonths" class="form-control" min="1" max="36" value="12" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">&nbsp;</label>
                                    <button class="btn btn-warning w-100" onclick="setForecastHorizon()">
                                        <i class="fas fa-calendar-check me-2"></i>–ó–∞–¥–∞—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <div class="alert alert-warning mb-0" style="font-size: 0.9em;">
                                        <i class="fas fa-info-circle me-2"></i>
                                        –£–∫–∞–∂–∏—Ç–µ –Ω–∞ —Å–∫–æ–ª—å–∫–æ –º–µ—Å—è—Ü–µ–≤ –≤–ø–µ—Ä–µ–¥ –Ω—É–∂–µ–Ω –ø—Ä–æ–≥–Ω–æ–∑
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –°–≤–æ–¥–∫–∞ -->
                        <div id="forecastSummary" style="display: none;" class="alert alert-success mt-3">
                            <h6><i class="fas fa-check-circle me-2"></i>–ù–∞—Å—Ç—Ä–æ–µ–Ω –≥–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞:</h6>
                            <div id="forecastSummaryContent"></div>
                        </div>
                    </div>
                </div>

                <!-- –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>–í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞
                            <small class="text-muted ms-2">(–ø—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –≤–ø—Ä–∞–≤–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –ø–µ—Ä–∏–æ–¥–æ–≤)</small>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="timeline-container" id="timelineContainer">
                            <p class="text-muted">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                <div class="text-center mb-4">
                    <button class="btn btn-secondary btn-lg me-3" onclick="goBack()">
                        <i class="fas fa-arrow-left me-2"></i>–ù–∞–∑–∞–¥
                    </button>
                    <button class="btn btn-success btn-lg" onclick="saveForecastSettings()">
                        <i class="fas fa-save me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentSessionId = null;
        let timeSeriesConfig = null;
        let existingTimeSeries = [];
        let forecastMonthsCount = 0;
        let forecastPeriods = [];
        let chartInstance = null;
        let metrics = [];
        let selectedMetric = null;
        let metricData = {};
        let timelineData = []; // –í—Å–µ –ø–µ—Ä–∏–æ–¥—ã (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ + –ø—Ä–æ–≥–Ω–æ–∑–Ω—ã–µ)

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async function() {
            // –†–µ–Ω–¥–µ—Ä–∏–º —Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏
            if (window.breadcrumbsModule) {
                window.breadcrumbsModule.render(4); // –®–∞–≥ 4 - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            currentSessionId = urlParams.get('session_id') || sessionStorage.getItem('currentSessionId');
            
            if (!currentSessionId) {
                alert('–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                window.location.href = '/forecast';
                return;
            }
            
            await loadData();
        });

        async function loadData() {
            try {
                const mappingStr = sessionStorage.getItem('dataMapping');
                const mapping = mappingStr ? JSON.parse(mappingStr) : null;
                
                if (!mapping || !mapping.columns) {
                    alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–ø–ø–∏–Ω–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –º–∞–ø–ø–∏–Ω–≥–∞.');
                    window.location.href = '/forecast/mapping';
                    return;
                }
                
                // –ù–∞—Ö–æ–¥–∏–º –º–µ—Ç—Ä–∏–∫–∏ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—è
                metrics = [];
                timeSeriesConfig = {};
                
                mapping.columns.forEach(col => {
                    if (col.role === 'metric' && col.include) {
                        metrics.push({
                            name: col.name,
                            displayName: col.name
                        });
                    }
                    if (col.time_series && col.include) {
                        timeSeriesConfig[col.time_series] = col.name;
                    }
                });
                
                console.log('–ú–µ—Ç—Ä–∏–∫–∏:', metrics);
                console.log('–í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—è:', timeSeriesConfig);
                
                await populateMetricSelect();
                await loadTimeSeries();
                buildTimelineData();
                renderTimeline();
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∑–∞–¥–∞–Ω
                await restoreForecastHorizon();
                
                await loadMetricData();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        }
        
        async function restoreForecastHorizon() {
            try {
                const response = await fetch(`/api/get_forecast_settings/${currentSessionId}`);
                const result = await response.json();
                
                if (result.success && result.settings) {
                    const settings = result.settings;
                    console.log('‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞:', settings);
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤
                    if (settings.forecast_months > 0) {
                        const monthsInput = document.getElementById('forecastMonths');
                        if (monthsInput) {
                            monthsInput.value = settings.forecast_months;
                        }
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç
                        forecastMonthsCount = settings.forecast_months;
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≥–Ω–æ–∑–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã
                        if (settings.forecast_periods && settings.forecast_periods.length > 0) {
                            forecastPeriods = settings.forecast_periods;
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º timeline —Å –ø—Ä–æ–≥–Ω–æ–∑–Ω—ã–º–∏ –ø–µ—Ä–∏–æ–¥–∞–º–∏
                            buildTimelineData();
                            renderTimeline();
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ (–Ω—É–∂–Ω–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫–∏)
                            setTimeout(() => {
                                renderMetricChart();
                            }, 500);
                            
                            console.log(`‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≥–æ—Ä–∏–∑–æ–Ω—Ç: ${settings.forecast_months} –º–µ—Å—è—Ü–µ–≤`);
                        }
                    }
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            }
        }

        async function populateMetricSelect() {
            const select = document.getElementById('metricSelect');
            select.innerHTML = '';
            
            if (metrics.length === 0) {
                select.innerHTML = '<option value="">–ú–µ—Ç—Ä–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
                return;
            }
            
            // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            let savedMetric = null;
            try {
                const response = await fetch(`/api/get_forecast_settings/${currentSessionId}`);
                const result = await response.json();
                if (result.success && result.settings) {
                    savedMetric = result.settings.metric;
                    console.log('‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞:', savedMetric);
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –º–µ—Ç—Ä–∏–∫—É');
            }
            
            metrics.forEach((metric, index) => {
                const option = document.createElement('option');
                option.value = metric.name;
                option.text = metric.displayName;
                
                // –í—ã–±–∏—Ä–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –º–µ—Ç—Ä–∏–∫—É –∏–ª–∏ –ø–µ—Ä–≤—É—é
                if (savedMetric && metric.name === savedMetric) {
                    option.selected = true;
                    selectedMetric = metric.name;
                    console.log('üìä –í—ã–±—Ä–∞–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞:', metric.name);
                } else if (!savedMetric && index === 0) {
                    option.selected = true;
                    selectedMetric = metric.name;
                }
                
                select.appendChild(option);
            });
        }

        async function loadTimeSeries() {
            try {
                const mappingStr = sessionStorage.getItem('dataMapping');
                const mapping = mappingStr ? JSON.parse(mappingStr) : null;
                
                if (!mapping) {
                    console.error('–ú–∞–ø–ø–∏–Ω–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ sessionStorage');
                    return;
                }
                
                const mappingParam = encodeURIComponent(JSON.stringify(mapping));
                const response = await fetch(`/api/get_time_series_values/${currentSessionId}?mapping=${mappingParam}`);
                const result = await response.json();
                
                if (result.success) {
                    existingTimeSeries = result.time_series;
                    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤:', existingTimeSeries.length);
                } else {
                    console.error('–û—à–∏–±–∫–∞:', result.message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤:', error);
            }
        }

        async function loadMetricData() {
            if (!selectedMetric) return;
            
            try {
                const response = await fetch(`/api/get_metric_time_series/${currentSessionId}?metric=${selectedMetric}`);
                const result = await response.json();
                
                if (result.success) {
                    metricData = result.data;
                    console.log('–î–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', metricData);
                    renderMetricChart();
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫–∏:', result.message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        function buildTimelineData() {
            timelineData = [];
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –≥–æ–¥–∞–º –∏ –º–µ—Å—è—Ü–∞–º
            const yearMonths = {};
            
            existingTimeSeries.forEach(item => {
                if (!item.year || !item.month) return;
                
                const year = item.year;
                const month = item.month;
                
                if (!yearMonths[year]) {
                    yearMonths[year] = new Set();
                }
                yearMonths[year].add(month);
            });
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            Object.keys(yearMonths).sort((a, b) => a - b).forEach(year => {
                const months = Array.from(yearMonths[year]).sort((a, b) => a - b);
                
                months.forEach(month => {
                    timelineData.push({
                        year: parseInt(year),
                        month: parseInt(month),
                        isForecast: false,
                        quarter: Math.ceil(month / 3),
                        halfyear: month <= 6 ? 1 : 2
                    });
                });
            });
            
            console.log('–ü–æ—Å—Ç—Ä–æ–µ–Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞:', timelineData.length, '–ø–µ—Ä–∏–æ–¥–æ–≤');
        }

        function setForecastHorizon() {
            const monthsInput = document.getElementById('forecastMonths');
            const months = parseInt(monthsInput.value);
            
            if (isNaN(months) || months < 1 || months > 36) {
                alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤ –æ—Ç 1 –¥–æ 36');
                return;
            }
            
            forecastMonthsCount = months;
            
            // –°–ù–ê–ß–ê–õ–ê –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ–≥–Ω–æ–∑–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã
            timelineData = timelineData.filter(p => !p.isForecast);
            forecastPeriods = [];
            
            // –ó–ê–¢–ï–ú –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–∏–æ–¥ –∏–∑ –§–ê–ö–¢–ò–ß–ï–°–ö–ò–• –¥–∞–Ω–Ω—ã—Ö
            if (timelineData.length === 0) {
                alert('–ù–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞');
                return;
            }
            
            const lastPeriod = timelineData[timelineData.length - 1];
            let currentYear = lastPeriod.year;
            let currentMonth = lastPeriod.month;
            
            console.log('–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–∏–æ–¥:', `${currentYear}-${currentMonth}`);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≥–Ω–æ–∑–Ω—ã–µ –º–µ—Å—è—Ü—ã
            for (let i = 0; i < months; i++) {
                currentMonth++;
                if (currentMonth > 12) {
                    currentMonth = 1;
                    currentYear++;
                }
                
                timelineData.push({
                    year: currentYear,
                    month: currentMonth,
                    isForecast: true,
                    quarter: Math.ceil(currentMonth / 3),
                    halfyear: currentMonth <= 6 ? 1 : 2
                });
            }
            
            console.log('–î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–æ–≥–Ω–æ–∑–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤:', months);
            console.log('–í—Å–µ–≥–æ –ø–µ—Ä–∏–æ–¥–æ–≤ –Ω–∞ —à–∫–∞–ª–µ:', timelineData.length);
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø—Ä–æ–≥–Ω–æ–∑–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã –ø–æ –≥–æ–¥–∞–º –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            const forecastByYear = {};
            timelineData.filter(p => p.isForecast).forEach(p => {
                if (!forecastByYear[p.year]) {
                    forecastByYear[p.year] = {
                        year: p.year,
                        months: [],
                        quarters: new Set(),
                        halfyears: new Set()
                    };
                }
                forecastByYear[p.year].months.push(p.month);
                forecastByYear[p.year].quarters.add(`Q${p.quarter}`);
                forecastByYear[p.year].halfyears.add(`H${p.halfyear}`);
            });
            
            forecastPeriods = Object.values(forecastByYear).map(y => ({
                year: y.year,
                months: y.months,
                quarters: Array.from(y.quarters),
                halfyears: Array.from(y.halfyears)
            }));
            
            renderTimeline();
            renderMetricChart();
            updateForecastSummary();
        }

        function renderTimeline() {
            const container = document.getElementById('timelineContainer');
            
            if (timelineData.length === 0) {
                container.innerHTML = '<p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                return;
            }
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –≥–æ–¥–∞–º
            const yearGroups = {};
            timelineData.forEach(period => {
                if (!yearGroups[period.year]) {
                    yearGroups[period.year] = [];
                }
                yearGroups[period.year].push(period);
            });
            
            let html = '';
            
            Object.keys(yearGroups).sort((a, b) => a - b).forEach(year => {
                const periods = yearGroups[year];
                const isForecastYear = periods.some(p => p.isForecast);
                
                html += `<div class="timeline-year">`;
                html += `<div class="year-header ${isForecastYear ? 'forecast' : ''}">${year}</div>`;
                html += `<div class="timeline-months">`;
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ 12 –º–µ—Å—è—Ü–µ–≤
                for (let m = 1; m <= 12; m++) {
                    const period = periods.find(p => p.month === m);
                    
                    if (period) {
                        const cellClass = period.isForecast ? 'month-cell forecast' : 'month-cell';
                        const monthNames = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];
                        
                        html += `<div class="${cellClass}" data-year="${year}" data-month="${m}">`;
                        html += `<div class="month-number">${m}</div>`;
                        html += `<div class="month-label">${monthNames[m-1]}</div>`;
                        html += `</div>`;
                    } else {
                        // –ü—É—Å—Ç–∞—è —è—á–µ–π–∫–∞ –¥–ª—è –º–µ—Å—è—Ü–µ–≤ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö
                        html += `<div class="month-cell" style="opacity: 0.3; border-style: dashed;">`;
                        html += `<div class="month-number">${m}</div>`;
                        html += `</div>`;
                    }
                }
                
                html += `</div>`;
                html += `</div>`;
            });
            
            container.innerHTML = html;
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –≥–æ–¥—É
            setTimeout(() => {
                const lastYear = container.querySelector('.timeline-year:last-child');
                if (lastYear) {
                    lastYear.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                }
            }, 100);
        }

        function updateForecastSummary() {
            const summaryDiv = document.getElementById('forecastSummary');
            const contentDiv = document.getElementById('forecastSummaryContent');
            
            if (forecastMonthsCount === 0) {
                summaryDiv.style.display = 'none';
                return;
            }
            
            summaryDiv.style.display = 'block';
            
            let html = `<p><strong>–ì–æ—Ä–∏–∑–æ–Ω—Ç:</strong> ${forecastMonthsCount} –º–µ—Å—è—Ü–µ–≤</p>`;
            html += `<p><strong>–ü—Ä–æ–≥–Ω–æ–∑–Ω—ã–µ –≥–æ–¥—ã:</strong></p>`;
            html += `<ul>`;
            
            forecastPeriods.forEach(period => {
                html += `<li><strong>${period.year}:</strong> ${period.months.length} –º–µ—Å—è—Ü–µ–≤ `;
                html += `(${period.halfyears.join(', ')}, ${period.quarters.join(', ')})`;
                html += `</li>`;
            });
            
            html += `</ul>`;
            
            contentDiv.innerHTML = html;
        }

        async function updateMetricChart() {
            const select = document.getElementById('metricSelect');
            selectedMetric = select.value;
            
            if (selectedMetric) {
                await loadMetricData();
            }
        }

        function renderMetricChart() {
            const canvas = document.getElementById('metricChart');
            if (!canvas) return;
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            if (!metricData.labels || metricData.labels.length === 0) {
                return;
            }
            
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const labels = [...metricData.labels];
            const historicalValues = [...metricData.values];
            const forecastValues = new Array(historicalValues.length).fill(null);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≥–Ω–æ–∑–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã (–º–µ—Å—è—Ü—ã)
            const forecastPeriods = timelineData.filter(p => p.isForecast);
            
            if (forecastPeriods.length > 0) {
                // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ª–∏–Ω–∏–π
                const lastHistoricalValue = historicalValues[historicalValues.length - 1];
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≥–Ω–æ–∑–Ω—ã–µ –º–µ—Å—è—Ü—ã
                forecastPeriods.forEach(period => {
                    const label = `${period.year}-${period.month.toString().padStart(2, '0')}`;
                    labels.push(label);
                    historicalValues.push(null);
                    
                    // –î–ª—è –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                    // —á—Ç–æ–±—ã –ª–∏–Ω–∏—è –±—ã–ª–∞ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π
                    forecastValues.push(lastHistoricalValue);
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–æ –ø—Ä–æ–≥–Ω–æ–∑–Ω–æ–π –ª–∏–Ω–∏–∏
                // —á—Ç–æ–±—ã –ª–∏–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å
                forecastValues[historicalValues.filter(v => v !== null).length - 1] = lastHistoricalValue;
            }
            
            const ctx = canvas.getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ',
                            data: historicalValues,
                            borderColor: '#2196F3',
                            backgroundColor: '#2196F333',
                            borderWidth: 4,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            tension: 0.2,
                            fill: false
                        },
                        {
                            label: '–ì–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞',
                            data: forecastValues,
                            borderColor: '#FF9800',
                            backgroundColor: '#FF980033',
                            borderWidth: 4,
                            borderDash: [10, 5],
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointStyle: 'rectRot',
                            tension: 0.2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${selectedMetric || '–ú–µ—Ç—Ä–∏–∫–∞'} - –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞`,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    if (value === null) return null;
                                    return `${label}: ${value.toLocaleString('ru-RU')}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '–ì–æ–¥'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '–ó–Ω–∞—á–µ–Ω–∏–µ'
                            },
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        async function saveForecastSettings() {
            if (!selectedMetric) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç—Ä–∏–∫—É –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }
            
            if (forecastMonthsCount === 0) {
                alert('–ó–∞–¥–∞–π—Ç–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞');
                return;
            }
            
            try {
                const settings = {
                    session_id: currentSessionId,
                    metric: selectedMetric,
                    forecast_months: forecastMonthsCount,
                    forecast_periods: forecastPeriods,
                    time_series_config: timeSeriesConfig
                };
                
                const response = await fetch('/api/save_forecast_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏
                    window.location.href = `/forecast/training?session_id=${currentSessionId}`;
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + result.message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
            }
        }

        function goBack() {
            if (confirm('–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥? –ù–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                window.location.href = '/forecast';
            }
        }
    </script>
</body>
</html>
