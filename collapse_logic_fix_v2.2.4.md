# Версия 2.2.4 - Исправление логики коллапсирования

## Проблема
Логика коллапсирования работала неправильно из-за неверного создания ключей для коллапсирования строк.

## Анализ проблемы

### Что было неправильно:

1. **Неправильный ключ коллапсирования**:
   ```javascript
   // СТАРАЯ ЛОГИКА (неправильная)
   const parentKey = this.createParentKey(rowFieldValues, index);
   // Для строки "2024|H1|Q1" и index=1 получался ключ "2024|H1"
   ```

2. **Неправильная логика видимости**:
   - Функция `isRowVisible` проверяла родительские ключи, но ключи создавались неправильно
   - Результат: строки не скрывались/показывались корректно

### Пример проблемы:
- **Строка**: `"2024|H1|Q1"` (год, полугодие, квартал)
- **rowFieldValues**: `["2024", "H1", "Q1"]`
- **index**: 1 (для полугодия H1)

**Что происходило**:
```javascript
// Создавался неправильный ключ
const parentKey = this.createParentKey(["2024", "H1", "Q1"], 1);
// parentKey = "2024|H1"

// При нажатии на кнопку у H1 добавлялся ключ "2024|H1" в collapsedRows
// Но это не скрывало дочерние строки типа "2024|H1|Q1"
```

## Исправления

### 1. Исправлен ключ коллапсирования
```javascript
// НОВАЯ ЛОГИКА (правильная)
if (shouldShowCollapseButton) {
    // Используем текущий rowKey как ключ для коллапсирования
    const collapseKey = rowKey;
    const isCollapsed = this.collapsedRows.has(collapseKey);
    const collapseIcon = isCollapsed ? '+' : '−';
    cellContent = `<span class="collapse-icon" onclick="toggleRowCollapse('${collapseKey}')" style="cursor: pointer; margin-right: 5px;">${collapseIcon}</span>${cellValue}`;
}
```

### 2. Исправлена логика видимости строк
```javascript
// НОВАЯ ЛОГИКА (правильная)
isRowVisible(rowKey, config) {
    // ... получение rowFields ...
    
    // Проверяем каждый уровень вложенности
    for (let level = 0; level < rowFields.length - 1; level++) {
        const parentKey = rowFields.slice(0, level + 1).join('|');
        if (this.collapsedRows.has(parentKey)) {
            return false; // Строка скрыта свернутым родителем
        }
    }
    
    return true;
}
```

## Как теперь работает логика

### Пример с вашими данными:

**Структура данных:**
- `"2024"` (год)
- `"2024|H1"` (полугодие)
- `"2024|H1|Q1"` (квартал)
- `"2024|H1|Q1|1"` (месяц)

**Сценарий: Пользователь нажимает на кнопку у H1**

1. **Кнопка коллапсирования** у строки `"2024|H1"` получает `onclick="toggleRowCollapse('2024|H1')"`
2. **При нажатии** добавляется ключ `"2024|H1"` в `collapsedRows`
3. **При проверке видимости** строки `"2024|H1|Q1"`:
   - `rowFields = ["2024", "H1", "Q1"]`
   - `level = 0`: `parentKey = "2024"` → не в `collapsedRows`
   - `level = 1`: `parentKey = "2024|H1"` → **ЕСТЬ в `collapsedRows`** → `return false`
4. **Результат**: строка `"2024|H1|Q1"` скрывается

## Результат
✅ Кнопки коллапсирования появляются у агрегированных строк (H1, H2, Q1, Q2, Q3, Q4)
✅ При нажатии на кнопку корректно скрываются/показываются дочерние строки
✅ Работает раскрытие конкретных кварталов (например, только Q1)
✅ Работает раскрытие конкретных месяцев внутри квартала

**Приложение запущено на http://localhost:5001 с версией 2.2.4**
